<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Vocab Stream</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&family=JetBrains+Mono:wght@500&display=swap');

        :root {
            --bg: #fdfcfa; --text: #1a1614; --primary: #2d5016; --primary-light: #4a7c2e;
            --accent: #f59e0b; --accent-light: #fbbf24; --surface: #ffffff;
            --surface-elevated: #f8f7f5; --border: #e8e6e3; --success: #10b981;
            --shadow: rgba(26,22,20,0.08);
        }
        [data-theme="dark"] {
            --bg: #0f0e0d; --text: #e8e6e3; --primary: #6b9b4d; --primary-light: #8bb56a;
            --accent: #fbbf24; --accent-light: #fcd34d; --surface: #1a1614;
            --surface-elevated: #252220; --border: #3a3632; --shadow: rgba(0,0,0,0.3);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body {
            font-family:'Be Vietnam Pro',sans-serif; background:var(--bg); color:var(--text);
            line-height:1.6; font-size:17px; transition:background 0.3s,color 0.3s; overflow-x:hidden;
        }
        .app-container { max-width:1400px; margin:0 auto; padding:20px; min-height:100vh; }

        /* HEADER */
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; padding-bottom:20px; border-bottom:2px solid var(--border); }
        .logo { font-family:'Crimson Pro',serif; font-size:clamp(28px,5vw,42px); font-weight:700; color:var(--primary); letter-spacing:-1px; }
        .theme-switch { width:56px; height:30px; background:var(--border); border-radius:15px; cursor:pointer; position:relative; transition:background 0.3s; }
        .theme-switch::before { content:'‚òÄÔ∏è'; position:absolute; left:4px; top:50%; transform:translateY(-50%); font-size:18px; transition:all 0.3s; }
        [data-theme="dark"] .theme-switch::before { content:'üåô'; left:30px; }

        /* NAV */
        .main-nav { display:flex; gap:12px; margin-bottom:30px; background:var(--surface); padding:8px; border-radius:12px; border:1px solid var(--border); }
        .nav-item { flex:1; padding:14px 20px; background:transparent; border:none; border-radius:8px; cursor:pointer; font-family:'Be Vietnam Pro',sans-serif; font-size:15px; font-weight:600; transition:all 0.2s; color:var(--text); }
        .nav-item.active { background:var(--primary); color:white; }
        .nav-item:not(.active):hover { background:var(--surface-elevated); }

        /* LESSON GRID */
        .lesson-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(90px,1fr)); gap:10px; margin-bottom:25px; }
        .lesson-btn { padding:18px 12px; background:var(--surface); border:2px solid var(--border); border-radius:10px; cursor:pointer; font-family:'Be Vietnam Pro',sans-serif; font-size:14px; font-weight:700; text-align:center; transition:all 0.25s cubic-bezier(0.4,0,0.2,1); color:var(--text); position:relative; }
        .lesson-btn:hover { transform:translateY(-3px); box-shadow:0 6px 20px var(--shadow); }
        .lesson-btn.active { background:var(--primary); color:white; border-color:var(--primary); transform:scale(1.05); }
        .lesson-btn.has-progress::after { content:'‚úì'; position:absolute; top:6px; right:6px; width:18px; height:18px; background:var(--success); color:white; border-radius:50%; font-size:11px; display:flex; align-items:center; justify-content:center; }

        /* TYPE TABS */
        .type-selector { display:flex; gap:12px; margin-bottom:25px; }
        .type-btn { flex:1; padding:12px 32px; background:var(--surface); border:2px solid var(--border); border-radius:25px; cursor:pointer; font-family:'Be Vietnam Pro',sans-serif; font-size:14px; font-weight:600; transition:all 0.2s; color:var(--text); }
        .type-btn.active { background:var(--accent); color:white; border-color:var(--accent); }
        .type-btn:hover:not(.active) { border-color:var(--accent-light); }

        /* PASSAGE SELECTOR */
        .passage-selector { display:flex; gap:10px; margin-bottom:25px; flex-wrap:wrap; }
        .passage-btn { padding:10px 20px; background:var(--surface); border:2px solid var(--border); border-radius:20px; cursor:pointer; font-family:'Be Vietnam Pro',sans-serif; font-size:13px; font-weight:600; transition:all 0.2s; color:var(--text); white-space:nowrap; }
        .passage-btn.active { background:var(--primary-light); color:white; border-color:var(--primary-light); }
        .passage-btn:hover:not(.active) { border-color:var(--primary-light); background:var(--surface-elevated); }

        /* PARAGRAPH BADGE - left side so it doesn't cover word */
        .paragraph-badge { position:absolute; top:8px; left:8px; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; font-family:'JetBrains Mono',monospace; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
        .paragraph-badge[data-para="A"] { background:#e74c3c; }
        .paragraph-badge[data-para="B"] { background:#3498db; }
        .paragraph-badge[data-para="C"] { background:#2ecc71; }
        .paragraph-badge[data-para="D"] { background:#f39c12; }
        .paragraph-badge[data-para="E"] { background:#9b59b6; }
        .paragraph-badge[data-para="F"] { background:#1abc9c; }
        .paragraph-badge[data-para="G"] { background:#e67e22; }
        .paragraph-badge[data-para="H"] { background:#34495e; }
        .paragraph-badge[data-para="I"] { background:#c0392b; }
        .paragraph-badge[data-para="J"] { background:#16a085; }

        /* STATS */
        .stats-bar { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin-bottom:30px; }
        .stat-card { background:var(--surface); padding:20px; border-radius:12px; border:1px solid var(--border); text-align:center; }
        .stat-value { font-size:32px; font-weight:700; color:var(--primary); margin-bottom:5px; }
        .stat-label { font-size:13px; opacity:0.7; font-weight:500; }

        /* VOCAB GRID */
        .vocab-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:16px; animation:fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        .vocab-card { background:var(--surface); border:2px solid var(--border); border-radius:12px; padding:20px 16px; cursor:pointer; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); text-align:center; position:relative; min-height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        /* cards with a paragraph badge get left padding so badge doesn't cover text */
        .vocab-card.has-badge { padding-left:44px; }
        .vocab-card:hover { transform:translateY(-5px) scale(1.02); box-shadow:0 12px 30px var(--shadow); border-color:var(--primary); }
        .vocab-card.viewed { opacity:0.7; }
        .vocab-card.viewed::after { content:'‚úì'; position:absolute; top:6px; right:6px; width:22px; height:22px; background:var(--success); color:white; border-radius:50%; font-size:13px; display:flex; align-items:center; justify-content:center; font-weight:700; }
        .vocab-card.viewed:hover { opacity:1; }
        .vocab-word { font-size:16px; font-weight:700; color:var(--text); line-height:1.3; }
        .vocab-meaning { font-size:12px; color:var(--text); opacity:0.6; margin-top:4px; line-height:1.3; }

        /* MODAL */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:999; display:none; }
        .modal-overlay.active { display:block; }
        .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.9); width:92%; max-width:500px; background:var(--surface); border-radius:24px; padding:40px 32px; z-index:1000; display:none; box-shadow:0 24px 60px rgba(0,0,0,0.2); animation:modalEnter 0.3s cubic-bezier(0.4,0,0.2,1) forwards; }
        .modal.active { display:block; }
        @keyframes modalEnter { from{opacity:0;transform:translate(-50%,-50%) scale(0.9)} to{opacity:1;transform:translate(-50%,-50%) scale(1)} }
        .modal-close { position:absolute; top:16px; right:16px; width:36px; height:36px; border-radius:50%; border:none; background:var(--surface-elevated); cursor:pointer; font-size:20px; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
        .modal-close:hover { background:var(--border); transform:rotate(90deg); }
        .modal-word { font-family:'Crimson Pro',serif; font-size:42px; font-weight:700; color:var(--primary); margin-bottom:8px; text-align:center; }
        .modal-type { display:inline-block; background:var(--accent); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:16px; }
        .modal-ipa { font-family:'JetBrains Mono',monospace; font-size:16px; color:var(--primary-light); margin-bottom:24px; text-align:center; background:var(--surface-elevated); padding:10px 16px; border-radius:8px; display:inline-block; }
        .modal-meaning { font-size:24px; font-weight:700; color:var(--text); margin-bottom:16px; text-align:center; }
        .modal-paraphrase { font-size:17px; line-height:1.8; opacity:0.9; margin-bottom:30px; text-align:center; background:var(--surface-elevated); padding:16px 20px; border-radius:12px; border-left:3px solid var(--accent); }
        .modal-actions { display:flex; gap:12px; }

        .btn { flex:1; padding:16px 24px; border:none; border-radius:12px; font-family:'Be Vietnam Pro',sans-serif; font-size:15px; font-weight:700; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-light); transform:translateY(-2px); box-shadow:0 6px 20px var(--shadow); }
        .btn-secondary { background:var(--accent); color:white; }
        .btn-secondary:hover { background:var(--accent-light); transform:translateY(-2px); }

        /* PROGRESS */
        .progress-container { max-width:800px; margin:0 auto; }
        .progress-section { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:30px; margin-bottom:30px; }
        .progress-title { font-size:20px; font-weight:700; color:var(--primary); margin-bottom:20px; }
        .progress-row { display:flex; align-items:center; gap:15px; margin-bottom:16px; }
        .progress-label { min-width:120px; font-weight:600; font-size:14px; }
        .progress-bar { flex:1; height:32px; background:var(--surface-elevated); border-radius:16px; overflow:hidden; border:1px solid var(--border); }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--primary),var(--primary-light)); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:13px; transition:width 0.5s cubic-bezier(0.4,0,0.2,1); }
        .progress-count { min-width:50px; text-align:right; font-weight:700; font-size:16px; }
        .export-section { display:flex; gap:12px; }

        /* EMPTY */
        .empty-state { text-align:center; padding:80px 20px; opacity:0.6; }
        .empty-icon { font-size:72px; margin-bottom:16px; }
        .empty-text { font-size:18px; font-weight:600; }

        /* TOAST */
        .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--primary); color:white; padding:12px 24px; border-radius:12px; font-weight:600; z-index:9999; box-shadow:0 8px 24px var(--shadow); transition:transform 0.3s,opacity 0.3s; opacity:0; }
        .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

        @media (max-width:768px) {
            .lesson-grid { grid-template-columns:repeat(auto-fit,minmax(70px,1fr)); }
            .vocab-grid { grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); }
            .modal { padding:32px 24px; }
            .modal-word { font-size:30px; }
            .type-selector { flex-direction:column; }
            .type-btn { width:100%; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="vocabModal">
    <button class="modal-close" id="modalClose">‚úï</button>
    <div id="modalContent"></div>
</div>

<div class="app-container">
    <header>
        <div class="logo">IELTS Vocab</div>
        <div class="header-controls">
            <div class="theme-switch" id="themeToggle"></div>
        </div>
    </header>
    <nav class="main-nav">
        <button class="nav-item active" data-view="reading">üìñ Reading</button>
        <button class="nav-item" data-view="listening">üéß Listening</button>
        <button class="nav-item" data-view="progress">üìä Progress</button>
    </nav>
    <div id="mainContent"></div>
</div>

<script src="vocab-data.js"></script>
<script>
// ==========================================
// STATE
// ==========================================
const state = {
    currentView: 'reading',
    currentLesson: 1,
    currentType: 'inclass',
    currentPassage: null,
    viewedWords: new Set()
};

// ==========================================
// STORAGE
// ==========================================
function saveState() {
    localStorage.setItem('ieltsVocabProgress', JSON.stringify({
        viewedWords: Array.from(state.viewedWords)
    }));
}
function loadState() {
    try {
        const saved = localStorage.getItem('ieltsVocabProgress');
        if (saved) state.viewedWords = new Set(JSON.parse(saved).viewedWords || []);
    } catch(e) {}
}

// ==========================================
// AUDIO
// ==========================================
let voices = [];
function loadVoices() {
    if ('speechSynthesis' in window) voices = window.speechSynthesis.getVoices();
}
function speak(word) {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'en-GB';
    u.rate = 0.85;
    const v = voices.find(v => v.lang.startsWith('en-GB'));
    if (v) u.voice = v;
    window.speechSynthesis.speak(u);
}

// ==========================================
// THEME
// ==========================================
function toggleTheme() {
    const dark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', dark ? '' : 'dark');
    localStorage.setItem('theme', dark ? 'light' : 'dark');
}

// ==========================================
// DATA HELPERS
// ==========================================

/**
 * THE KEY FIX:
 * Reading L7 homework has nested passages (keys point to objects WITHOUT 'ipa').
 * Listening L6 homework is flat (keys point to objects WITH 'ipa').
 * This function reliably distinguishes the two.
 */
function isNestedPassages(data) {
    if (!data || Object.keys(data).length === 0) return false;
    const firstVal = data[Object.keys(data)[0]];
    return firstVal && typeof firstVal === 'object' && !('ipa' in firstVal);
}

function getCurrentVocabData() {
    const raw = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType];
    if (!raw) return {};
    if (isNestedPassages(raw)) {
        if (state.currentPassage) return raw[state.currentPassage] || {};
        // Combine all passages
        const combined = {};
        Object.values(raw).forEach(p => Object.assign(combined, p));
        return combined;
    }
    return raw;
}

function getAllWordsFromData(data) {
    if (!data || Object.keys(data).length === 0) return [];
    if (isNestedPassages(data)) return Object.values(data).flatMap(p => Object.keys(p));
    return Object.keys(data);
}

function hasLessonProgress(view, lesson) {
    for (const type of ['inclass', 'homework']) {
        const words = getAllWordsFromData(VOCAB_DATA[view]?.[lesson]?.[type]);
        if (words.some(w => state.viewedWords.has(w))) return true;
    }
    return false;
}

function getCategoryTotal(cat) {
    let n = 0;
    for (const lesson of Object.keys(VOCAB_DATA[cat]))
        for (const type of ['inclass','homework'])
            n += getAllWordsFromData(VOCAB_DATA[cat][lesson][type]).length;
    return n;
}
function getCategoryViewed(cat) {
    let n = 0;
    for (const lesson of Object.keys(VOCAB_DATA[cat]))
        for (const type of ['inclass','homework'])
            getAllWordsFromData(VOCAB_DATA[cat][lesson][type]).forEach(w => { if (state.viewedWords.has(w)) n++; });
    return n;
}
function getTotalWords() { return getCategoryTotal('reading') + getCategoryTotal('listening'); }

// ==========================================
// NAVIGATION ‚Äî THE BUG FIX
// Switching Reading ‚Üî Listening resets lesson to 1.
// This prevents Listening inheriting Reading L7's nested-passage state.
// ==========================================
function setView(view) {
    state.currentView = view;
    state.currentLesson = 1;       // ‚Üê reset
    state.currentType = 'inclass'; // ‚Üê reset
    state.currentPassage = null;   // ‚Üê reset
    document.querySelectorAll('.nav-item').forEach(b =>
        b.classList.toggle('active', b.dataset.view === view)
    );
    render();
}

function setLesson(num) {
    state.currentLesson = num;
    state.currentPassage = null;
    render();
}
function setType(type) {
    state.currentType = type;
    state.currentPassage = null;
    render();
}
function setPassage(name) {
    state.currentPassage = name;
    render();
}

// ==========================================
// RENDER
// ==========================================
function render() {
    const content = document.getElementById('mainContent');
    state.currentView === 'progress' ? renderProgress(content) : renderVocabView(content);
}

function renderVocabView(container) {
    const maxLessons = state.currentView === 'reading' ? 7 : 8;
    container.innerHTML = '';

    // Lesson grid
    const lessonsDiv = document.createElement('div');
    lessonsDiv.className = 'lesson-grid';
    for (let i = 1; i <= maxLessons; i++) {
        const btn = document.createElement('button');
        btn.className = 'lesson-btn' + (i === state.currentLesson ? ' active' : '');
        btn.textContent = `Lesson ${i}`;
        if (hasLessonProgress(state.currentView, i)) btn.classList.add('has-progress');
        btn.addEventListener('click', () => setLesson(i));
        lessonsDiv.appendChild(btn);
    }
    container.appendChild(lessonsDiv);

    // In Class / Homework
    const typeDiv = document.createElement('div');
    typeDiv.className = 'type-selector';
    for (const [t, label] of [['inclass','In Class'],['homework','Homework']]) {
        const btn = document.createElement('button');
        btn.className = 'type-btn' + (state.currentType === t ? ' active' : '');
        btn.textContent = label;
        btn.addEventListener('click', () => setType(t));
        typeDiv.appendChild(btn);
    }
    container.appendChild(typeDiv);

    // Passage selector ‚Äî ONLY shown when data is truly nested (has passages)
    const rawData = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType];
    if (rawData && isNestedPassages(rawData)) {
        const passageDiv = document.createElement('div');
        passageDiv.className = 'passage-selector';

        const allBtn = document.createElement('button');
        allBtn.className = 'passage-btn' + (state.currentPassage === null ? ' active' : '');
        allBtn.textContent = 'üìö All Passages';
        allBtn.addEventListener('click', () => setPassage(null));
        passageDiv.appendChild(allBtn);

        Object.keys(rawData).forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'passage-btn' + (state.currentPassage === name ? ' active' : '');
            btn.textContent = name;
            btn.addEventListener('click', () => setPassage(name));
            passageDiv.appendChild(btn);
        });
        container.appendChild(passageDiv);
    }

    // Stats
    const data = getCurrentVocabData();
    const words = Object.keys(data);
    const viewedCount = words.filter(w => state.viewedWords.has(w)).length;
    const statsDiv = document.createElement('div');
    statsDiv.className = 'stats-bar';
    statsDiv.innerHTML = `
        <div class="stat-card"><div class="stat-value">${words.length}</div><div class="stat-label">T·ªïng t·ª´</div></div>
        <div class="stat-card"><div class="stat-value">${viewedCount}</div><div class="stat-label">ƒê√£ xem</div></div>
        <div class="stat-card"><div class="stat-value">${state.currentView === 'reading' ? 'Reading' : 'Listening'} L${state.currentLesson}</div><div class="stat-label">B·ªô hi·ªán t·∫°i</div></div>
    `;
    container.appendChild(statsDiv);

    // Vocab grid
    const gridDiv = document.createElement('div');
    if (words.length === 0) {
        gridDiv.className = 'empty-state';
        gridDiv.innerHTML = `<div class="empty-icon">üî≠</div><div class="empty-text">Ch∆∞a c√≥ t·ª´ v·ª±ng cho b√†i n√†y</div>`;
    } else {
        gridDiv.className = 'vocab-grid';
        const sorted = [...words].sort((a,b) => {
            const pA = data[a]?.paragraph || 'Z';
            const pB = data[b]?.paragraph || 'Z';
            return pA.localeCompare(pB);
        });
        sorted.forEach(word => {
            const hasBadge = !!(data[word]?.paragraph);
            const card = document.createElement('div');
            card.className = 'vocab-card'
                + (state.viewedWords.has(word) ? ' viewed' : '')
                + (hasBadge ? ' has-badge' : '');
            card.dataset.word = word;

            if (hasBadge) {
                const badge = document.createElement('div');
                badge.className = 'paragraph-badge';
                badge.setAttribute('data-para', data[word].paragraph);
                badge.textContent = data[word].paragraph;
                card.appendChild(badge);
            }

            const wordEl = document.createElement('div');
            wordEl.className = 'vocab-word';
            wordEl.textContent = word;
            card.appendChild(wordEl);

            const meaningEl = document.createElement('div');
            meaningEl.className = 'vocab-meaning';
            meaningEl.textContent = data[word]?.meaning || '';
            card.appendChild(meaningEl);

            gridDiv.appendChild(card);
        });

        gridDiv.addEventListener('click', e => {
            const card = e.target.closest('.vocab-card');
            if (card?.dataset.word) showWord(card.dataset.word);
        });
    }
    container.appendChild(gridDiv);
}

function renderProgress(container) {
    const total = getTotalWords(), viewed = state.viewedWords.size;
    const pct = total > 0 ? Math.round(viewed/total*100) : 0;
    const rT = getCategoryTotal('reading'), lT = getCategoryTotal('listening');
    const rV = getCategoryViewed('reading'), lV = getCategoryViewed('listening');
    const rP = rT > 0 ? Math.round(rV/rT*100) : 0;
    const lP = lT > 0 ? Math.round(lV/lT*100) : 0;
    container.innerHTML = `
        <div class="progress-container">
            <div class="progress-section">
                <div class="progress-title">üìä Ti·∫øn ƒë·ªô t·ªïng th·ªÉ</div>
                <div class="progress-row">
                    <div class="progress-label">T·ªïng</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%">${pct}%</div></div>
                    <div class="progress-count">${viewed}/${total}</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-title">üìö Theo k·ªπ nƒÉng</div>
                <div class="progress-row">
                    <div class="progress-label">üìñ Reading</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${rP}%">${rV}/${rT}</div></div>
                    <div class="progress-count">${rV}</div>
                </div>
                <div class="progress-row">
                    <div class="progress-label">üéß Listening</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${lP}%">${lV}/${lT}</div></div>
                    <div class="progress-count">${lV}</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-title">üíæ L∆∞u ti·∫øn ƒë·ªô</div>
                <div class="export-section">
                    <button class="btn btn-primary" id="exportBtn">üì§ Xu·∫•t ti·∫øn ƒë·ªô</button>
                    <button class="btn btn-secondary" id="importBtn">üì• Nh·∫≠p ti·∫øn ƒë·ªô</button>
                </div>
            </div>
        </div>
    `;
    document.getElementById('exportBtn').addEventListener('click', exportProgress);
    document.getElementById('importBtn').addEventListener('click', importProgress);
}

// ==========================================
// MODAL
// ==========================================
function showWord(word) {
    const data = getCurrentVocabData()[word];
    if (!data) return;
    state.viewedWords.add(word);
    saveState();

    const content = document.getElementById('modalContent');
    content.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.style.textAlign = 'center';

    const els = {
        word: Object.assign(document.createElement('div'), {className:'modal-word', textContent:word}),
        type: Object.assign(document.createElement('span'), {className:'modal-type', textContent:data.type}),
        ipa:  Object.assign(document.createElement('div'), {className:'modal-ipa', textContent:data.ipa}),
        meaning: Object.assign(document.createElement('div'), {className:'modal-meaning', textContent:data.meaning}),
        para: Object.assign(document.createElement('div'), {className:'modal-paraphrase', textContent:data.paraphrase})
    };
    Object.values(els).forEach(el => wrapper.appendChild(el));

    const actions = document.createElement('div');
    actions.className = 'modal-actions';

    const listenBtn = document.createElement('button');
    listenBtn.className = 'btn btn-primary';
    listenBtn.textContent = 'üîä Listen';
    listenBtn.addEventListener('click', () => speak(word));

    const youglishBtn = document.createElement('button');
    youglishBtn.className = 'btn btn-secondary';
    youglishBtn.textContent = '‚ñ∂Ô∏è YouGlish';
    youglishBtn.addEventListener('click', () =>
        window.open(`https://youglish.com/pronounce/${encodeURIComponent(word)}/english/uk`, '_blank'));

    actions.append(listenBtn, youglishBtn);
    content.append(wrapper, actions);

    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('vocabModal').classList.add('active');
    setTimeout(() => speak(word), 100);
    render();
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('vocabModal').classList.remove('active');
}

// ==========================================
// EXPORT / IMPORT
// ==========================================
function exportProgress() {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify({
        viewedWords: Array.from(state.viewedWords),
        exportDate: new Date().toISOString()
    }, null, 2)], {type:'application/json'}));
    a.download = `ielts-vocab-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}
function importProgress() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = e => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                state.viewedWords = new Set(JSON.parse(ev.target.result).viewedWords || []);
                saveState(); render(); showToast('‚úÖ Nh·∫≠p ti·∫øn ƒë·ªô th√†nh c√¥ng!');
            } catch { showToast('‚ùå File kh√¥ng h·ª£p l·ªá.'); }
        };
        reader.readAsText(file);
    };
    input.click();
}

function showToast(msg) {
    document.querySelector('.toast')?.remove();
    const t = document.createElement('div');
    t.className = 'toast'; t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2500);
}

// ==========================================
// INIT
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme','dark');
    if ('speechSynthesis' in window) { loadVoices(); window.speechSynthesis.onvoiceschanged = loadVoices; }

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
    document.querySelectorAll('.nav-item').forEach(btn =>
        btn.addEventListener('click', () => setView(btn.dataset.view))
    );
    render();
});
</script>
</body>
</html>
