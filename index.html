<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Vocab Stream</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&family=JetBrains+Mono:wght@500&display=swap');

        :root {
            --bg: #fdfcfa;
            --text: #1a1614;
            --primary: #2d5016;
            --primary-light: #4a7c2e;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --surface: #ffffff;
            --surface-elevated: #f8f7f5;
            --border: #e8e6e3;
            --success: #10b981;
            --shadow: rgba(26, 22, 20, 0.08);
        }

        [data-theme="dark"] {
            --bg: #0f0e0d;
            --text: #e8e6e3;
            --primary: #6b9b4d;
            --primary-light: #8bb56a;
            --accent: #fbbf24;
            --accent-light: #fcd34d;
            --surface: #1a1614;
            --surface-elevated: #252220;
            --border: #3a3632;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -1px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-switch {
            width: 56px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .theme-switch::before {
            content: '‚òÄÔ∏è';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            transition: all 0.3s;
        }

        [data-theme="dark"] .theme-switch::before {
            content: 'üåô';
            left: 30px;
        }

        /* ===== STREAK BAR ===== */
        .streak-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            min-height: 20px;
        }

        .streak-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 700;
            border: 2px solid var(--border);
            background: var(--surface);
            white-space: nowrap;
        }

        .streak-chip-fire {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border-color: transparent;
            color: white;
        }

        .streak-chip-due {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: transparent;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .streak-chip-due:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }

        .streak-chip-mastered {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.4);
            color: #047857;
        }

        [data-theme="dark"] .streak-chip-mastered {
            color: var(--success);
        }

        /* ===== NAVIGATION ===== */
        .main-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            background: var(--surface);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .nav-item {
            flex: 1;
            padding: 12px 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item:not(.active):hover {
            background: var(--surface-elevated);
        }

        /* ===== LESSON SELECTOR ===== */
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .lesson-btn {
            padding: 18px 12px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text);
            position: relative;
        }

        .lesson-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .lesson-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .lesson-btn.has-progress::after {
            content: '‚úì';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== TYPE SELECTOR ===== */
        .type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        .type-btn {
            flex: 1;
            padding: 12px 32px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
        }

        .type-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .type-btn:hover:not(.active) {
            border-color: var(--accent-light);
        }

        /* ===== PASSAGE SELECTOR ===== */
        .passage-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .passage-btn {
            padding: 10px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
            white-space: nowrap;
        }

        .passage-btn.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .passage-btn:hover:not(.active) {
            border-color: var(--primary-light);
            background: var(--surface-elevated);
        }

        /* ===== PARAGRAPH BADGE ===== */
        .paragraph-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .paragraph-badge[data-para="A"] { background: #e74c3c; }
        .paragraph-badge[data-para="B"] { background: #3498db; }
        .paragraph-badge[data-para="C"] { background: #2ecc71; }
        .paragraph-badge[data-para="D"] { background: #f39c12; }
        .paragraph-badge[data-para="E"] { background: #9b59b6; }
        .paragraph-badge[data-para="F"] { background: #1abc9c; }
        .paragraph-badge[data-para="G"] { background: #e67e22; }
        .paragraph-badge[data-para="H"] { background: #34495e; }
        .paragraph-badge[data-para="I"] { background: #c0392b; }
        .paragraph-badge[data-para="J"] { background: #16a085; }

        /* ===== MASTERY BADGE (bottom of vocab card) ===== */
        .mastery-badge {
            position: absolute;
            bottom: 7px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 8px;
            white-space: nowrap;
            pointer-events: none;
        }

        .mastery-new      { background: var(--surface-elevated); color: var(--text); border: 1px solid var(--border); opacity: 0.6; }
        .mastery-learning { background: rgba(245,158,11,0.15); color: #b45309; border: 1px solid rgba(245,158,11,0.35); }
        .mastery-mastered { background: rgba(16,185,129,0.15); color: #047857; border: 1px solid rgba(16,185,129,0.4); }

        [data-theme="dark"] .mastery-learning { color: var(--accent-light); }
        [data-theme="dark"] .mastery-mastered { color: #34d399; }

        .vocab-card { position: relative; }

        /* ===== STATS BAR ===== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.7;
            font-weight: 500;
        }

        /* ===== VOCAB GRID ===== */
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .vocab-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px 16px 30px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vocab-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 30px var(--shadow);
            border-color: var(--primary);
        }

        .vocab-card.card-learning { border-color: rgba(245,158,11,0.45); }
        .vocab-card.card-mastered { border-color: rgba(16,185,129,0.5); }
        .vocab-card.viewed        { opacity: 0.75; }
        .vocab-card.viewed:hover  { opacity: 1; }

        .vocab-word {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.3;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: none;
            animation: fadeInOverlay 0.25s ease-out;
        }

        .modal-overlay.active { display: block; }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 92%;
            max-width: 500px;
            background: var(--surface);
            border-radius: 24px;
            padding: 40px 32px;
            z-index: 1000;
            display: none;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2);
            animation: modalEnter 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .modal.active { display: block; }

        @keyframes modalEnter {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--surface-elevated);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--border);
            transform: rotate(90deg);
        }

        .modal-word {
            font-family: 'Crimson Pro', serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            text-align: center;
        }

        .modal-type {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .modal-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            color: var(--primary-light);
            margin-bottom: 24px;
            text-align: center;
            background: var(--surface-elevated);
            padding: 10px 16px;
            border-radius: 8px;
            display: inline-block;
        }

        .modal-meaning {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            text-align: center;
        }

        .modal-paraphrase {
            font-size: 17px;
            line-height: 1.8;
            opacity: 0.9;
            margin-bottom: 30px;
            text-align: center;
            background: var(--surface-elevated);
            padding: 16px 20px;
            border-radius: 12px;
            border-left: 3px solid var(--accent);
        }

        /* Bold word inside paraphrase */
        .modal-paraphrase strong,
        .review-paraphrase strong {
            font-weight: 700;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .btn-secondary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .btn-ghost {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-ghost:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* ===== REVIEW VIEW ===== */
        .review-wrap {
            max-width: 600px;
            margin: 0 auto;
        }

        .review-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .review-meta-text {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.65;
        }

        .review-prog-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin-bottom: 28px;
            overflow: hidden;
        }

        .review-prog-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .review-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 40px 32px 32px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
        }

        .review-word {
            font-family: 'Crimson Pro', serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.1;
        }

        .review-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            color: var(--primary-light);
            background: var(--surface-elevated);
            padding: 8px 14px;
            border-radius: 8px;
        }

        .review-divider {
            width: 100%;
            border: none;
            border-top: 1px solid var(--border);
            margin: 4px 0;
        }

        .review-meaning {
            font-size: 22px;
            font-weight: 700;
        }

        .review-paraphrase {
            font-size: 15px;
            line-height: 1.7;
            opacity: 0.85;
            background: var(--surface-elevated);
            padding: 12px 16px;
            border-radius: 10px;
            border-left: 3px solid var(--accent);
            text-align: left;
            width: 100%;
        }

        .review-answer { display: none; width: 100%; }
        .review-answer.visible { display: contents; animation: fadeIn 0.25s ease; }

        .review-reveal-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-reveal-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        /* ===== RECALL QUESTION LABEL ===== */
        .recall-question {
            width: 100%;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            opacity: 0.75;
            margin-bottom: 4px;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            display: none;
        }

        .recall-question.visible {
            display: block;
            animation: fadeIn 0.25s ease;
        }

        .recall-question span {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 13px;
            margin-top: 4px;
        }

        /* Rating buttons ‚Äî 3 col */
        .review-ratings {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
        }

        .review-ratings.visible { display: grid; animation: fadeIn 0.25s ease; }

        .rating-btn {
            padding: 16px 8px;
            border: 2px solid;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            background: transparent;
        }

        .rating-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 18px var(--shadow); }

        /* FIX: renamed from Kh√≥/ƒê∆∞·ª£c/D·ªÖ ‚Üí H∆°i l√¢u / B√¨nh th∆∞·ªùng / R·∫•t nhanh */
        .rating-slow   { border-color: rgba(239,68,68,0.4);   color: #dc2626; }
        .rating-slow:hover   { background: rgba(239,68,68,0.08); }
        .rating-normal { border-color: rgba(245,158,11,0.4);  color: #b45309; }
        .rating-normal:hover { background: rgba(245,158,11,0.08); }
        .rating-fast   { border-color: rgba(16,185,129,0.4);  color: #047857; }
        .rating-fast:hover   { background: rgba(16,185,129,0.08); }

        [data-theme="dark"] .rating-normal { color: var(--accent-light); }
        [data-theme="dark"] .rating-fast   { color: #34d399; }

        .rating-emoji { font-size: 24px; }
        .rating-label { font-size: 13px; }
        .rating-days  { font-size: 11px; opacity: 0.6; font-weight: 600; }

        /* Review done screen */
        .review-done { text-align: center; padding: 60px 20px; animation: fadeIn 0.4s ease; }
        .review-done-icon  { font-size: 72px; margin-bottom: 20px; }
        .review-done-title { font-family: 'Crimson Pro', serif; font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .review-done-sub   { font-size: 16px; opacity: 0.7; margin-bottom: 32px; line-height: 1.6; }
        .review-done-btns  { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

        /* ===== PROGRESS VIEW ===== */
        .progress-container { max-width: 800px; margin: 0 auto; }

        .progress-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .progress-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 16px;
        }

        .progress-label { min-width: 120px; font-weight: 600; font-size: 14px; }

        .progress-bar {
            flex: 1;
            height: 32px;
            background: var(--surface-elevated);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 13px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 32px;
        }

        .progress-fill-green { background: linear-gradient(90deg, #059669, #10b981); }
        .progress-fill-amber { background: linear-gradient(90deg, #d97706, #f59e0b); }

        .progress-count { min-width: 50px; text-align: right; font-weight: 700; font-size: 16px; }

        .export-section { display: flex; gap: 12px; }

        /* ===== EMPTY STATE ===== */
        .empty-state { text-align: center; padding: 80px 20px; opacity: 0.6; }
        .empty-icon  { font-size: 72px; margin-bottom: 16px; }
        .empty-text  { font-size: 18px; font-weight: 600; }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 8px 24px var(--shadow);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            opacity: 0;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        
        /* ===== QUIZ ===== */
        .quiz-wrap { max-width: 640px; margin: 0 auto; }
        .quiz-locked { text-align:center; padding:60px 20px; background:var(--surface); border:1px solid var(--border); border-radius:20px; }
        .quiz-locked-icon { font-size:64px; margin-bottom:16px; }
        .quiz-locked-title { font-family:'Crimson Pro',serif; font-size:28px; font-weight:700; color:var(--primary); margin-bottom:10px; }
        .quiz-locked-sub { font-size:15px; opacity:0.7; margin-bottom:28px; line-height:1.7; }
        .quiz-unlock-bars { display:flex; flex-direction:column; gap:12px; margin-bottom:28px; }
        .quiz-unlock-row { display:flex; align-items:center; gap:12px; }
        .quiz-unlock-label { min-width:110px; font-size:13px; font-weight:700; text-align:left; }
        .quiz-unlock-bar { flex:1; height:12px; background:var(--surface-elevated); border-radius:6px; overflow:hidden; border:1px solid var(--border); }
        .quiz-unlock-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-light)); border-radius:6px; transition:width 0.5s ease; }
        .quiz-unlock-count { min-width:60px; font-size:13px; font-weight:700; text-align:right; opacity:0.7; }
        .quiz-start { text-align:center; padding:48px 24px; background:var(--surface); border:1px solid var(--border); border-radius:20px; }
        .quiz-start-icon { font-size:64px; margin-bottom:16px; }
        .quiz-start-title { font-family:'Crimson Pro',serif; font-size:28px; font-weight:700; color:var(--primary); margin-bottom:10px; }
        .quiz-start-sub { font-size:15px; opacity:0.7; margin-bottom:28px; line-height:1.7; }
        .quiz-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .quiz-counter { font-size:14px; font-weight:700; opacity:0.6; }
        .quiz-score-live { font-size:14px; font-weight:700; color:var(--success); }
        .quiz-prog-bar { height:6px; background:var(--border); border-radius:3px; margin-bottom:28px; overflow:hidden; }
        .quiz-prog-fill { height:100%; background:var(--accent); border-radius:3px; transition:width 0.4s ease; }
        .quiz-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:32px 28px; margin-bottom:20px; }
        .quiz-question-label { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--accent); margin-bottom:12px; }
        .quiz-question-word { font-family:'Crimson Pro',serif; font-size:36px; font-weight:700; color:var(--primary); text-align:center; margin-bottom:4px; }
        .quiz-question-ipa { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--primary-light); text-align:center; margin-bottom:24px; opacity:0.8; }
        .quiz-options { display:flex; flex-direction:column; gap:10px; }
        .quiz-option { padding:16px 20px; background:var(--surface-elevated); border:2px solid var(--border); border-radius:12px; cursor:pointer; font-size:15px; font-weight:600; text-align:left; transition:all 0.2s; color:var(--text); display:flex; align-items:center; gap:12px; }
        .quiz-option:hover:not(.disabled) { border-color:var(--primary); background:var(--surface); transform:translateX(4px); }
        .quiz-option.selected { border-color:var(--primary); background:rgba(45,80,22,0.08); }
        .quiz-option.correct { border-color:var(--success); background:rgba(16,185,129,0.1); color:#047857; }
        .quiz-option.wrong { border-color:#ef4444; background:rgba(239,68,68,0.08); color:#dc2626; }
        .quiz-option.disabled { cursor:default; }
        .quiz-option-letter { width:28px; height:28px; border-radius:50%; background:var(--border); color:var(--text); font-size:12px; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .quiz-option.correct .quiz-option-letter { background:var(--success); color:white; }
        .quiz-option.wrong   .quiz-option-letter { background:#ef4444; color:white; }
        .quiz-option.selected:not(.correct):not(.wrong) .quiz-option-letter { background:var(--primary); color:white; }
        .quiz-feedback { display:none; padding:14px 18px; border-radius:12px; font-size:14px; font-weight:700; margin-top:12px; line-height:1.5; }
        .quiz-feedback.show { display:block; animation:fadeIn 0.25s ease; }
        .quiz-feedback.correct { background:rgba(16,185,129,0.12); color:#047857; border:1px solid rgba(16,185,129,0.3); }
        .quiz-feedback.wrong   { background:rgba(239,68,68,0.08); color:#dc2626; border:1px solid rgba(239,68,68,0.2); }
        .quiz-next-btn { width:100%; padding:18px; background:var(--primary); color:white; border:none; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.2s; display:none; }
        .quiz-next-btn.show { display:block; animation:fadeIn 0.2s ease; }
        .quiz-next-btn:hover { background:var(--primary-light); transform:translateY(-2px); }
        .quiz-results { text-align:center; padding:48px 24px; background:var(--surface); border:1px solid var(--border); border-radius:20px; animation:fadeIn 0.4s ease; }
        .quiz-results-score { font-family:'Crimson Pro',serif; font-size:80px; font-weight:700; color:var(--primary); line-height:1; margin-bottom:8px; }
        .quiz-results-label { font-size:16px; font-weight:600; opacity:0.6; margin-bottom:16px; }
        .quiz-results-msg { font-size:22px; font-weight:700; margin-bottom:8px; }
        .quiz-results-sub { font-size:15px; opacity:0.65; margin-bottom:32px; }
        .quiz-results-btns { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

/* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-controls { flex-direction: column; gap: 8px; }
            .lesson-grid     { grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); }
            .vocab-grid      { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
            .modal           { padding: 32px 24px; }
            .modal-word      { font-size: 30px; }
            .type-selector   { flex-direction: column; }
            .type-btn        { width: 100%; }
            .review-word     { font-size: 36px; }
            .review-card     { padding: 28px 20px 24px; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="vocabModal">
    <button class="modal-close" id="modalClose">‚úï</button>
    <div id="modalContent"></div>
</div>

<div class="app-container">
    <header>
        <div class="logo">IELTS Vocab</div>
        <div class="header-controls">
            <div class="theme-switch" id="themeToggle"></div>
        </div>
    </header>

    <div id="streakBar" class="streak-bar"></div>

    <nav class="main-nav" id="mainNav">
        <button class="nav-item active" data-view="reading">üìñ Reading</button>
        <button class="nav-item" data-view="listening">üéß Listening</button>
        <button class="nav-item" data-view="review">üîÅ √în t·∫≠p</button>
        <button class="nav-item" data-view="quiz">üß† Quiz</button>
        <button class="nav-item" data-view="progress">üìä Progress</button>
    </nav>

    <div id="mainContent"></div>
</div>

<script src="vocab-data.js"></script>

<script>
// ==========================================
// URL HASH MANAGER
// ==========================================
const URLHashManager = {
    update(view, lesson, type) {
        try {
        if (view === 'review' || view === 'progress' || view === 'quiz') {
            window.history.replaceState(null, '', '#' + view);
        } else {
            window.history.replaceState(null, '', '#' + view + '-' + lesson + '-' + type);
        }
        } catch(e) {} /* iframe: ignore replaceState error */
    },
    load() {
        const hash = window.location.hash.slice(1);
        if (!hash) return null;
        if (hash === 'review' || hash === 'progress' || hash === 'quiz') return { view: hash };
        const parts = hash.split('-');
        if (parts.length !== 3) return null;
        const [view, lesson, type] = parts;
        const lessonNum = parseInt(lesson);
        if ((view !== 'reading' && view !== 'listening') ||
            isNaN(lessonNum) ||
            !VOCAB_DATA[view][lessonNum] ||
            (type !== 'inclass' && type !== 'homework')) return null;
        return { view, lesson: lessonNum, type };
    }
};

// ==========================================
// SRS ‚Äî SM-2+ algorithm
// rating: 0=H∆°i l√¢u, 1=B√¨nh th∆∞·ªùng, 2=R·∫•t nhanh
// ==========================================
function defaultSRS() {
    return { interval: 1, easeFactor: 2.5, reviewCount: 0, nextReview: new Date().toISOString() };
}

function calcNextReview(srs, rating) {
    let { interval, easeFactor, reviewCount } = srs;

    easeFactor = Math.min(3.0, Math.max(1.3,
        easeFactor + 0.1 - (2 - rating) * (0.08 + (2 - rating) * 0.02)
    ));

    if (rating === 0) {
        interval = 1;
        reviewCount = 0;
    } else if (reviewCount === 0) {
        interval = 1;
    } else if (reviewCount === 1) {
        interval = 6;
    } else {
        interval = Math.round(interval * easeFactor);
    }

    reviewCount++;

    const next = new Date();
    next.setDate(next.getDate() + interval);

    return { interval, easeFactor, reviewCount, nextReview: next.toISOString() };
}

function getMastery(srs) {
    if (!srs || srs.reviewCount === 0) return 'new';
    if (srs.reviewCount >= 5) return 'mastered';
    return 'learning';
}

function isDue(srs) {
    if (!srs || srs.reviewCount === 0) return false;
    return new Date(srs.nextReview) <= new Date();
}

// ==========================================
// STATE
// ==========================================
let state = {
    currentView: 'reading',
    currentLesson: 1,
    currentType: 'inclass',
    currentPassage: null,
    viewedWords: new Set(),
    reviewSchedule: {},
    streak: 0,
    lastVisit: null,
    currentModalWord: null,
    reviewQueue: [],
    reviewIdx: 0,
    reviewRevealed: false,
    reviewDone: false,
    reviewSessionCount: 0,
    reviewSessionStarted: false,
    quizStarted: false,
    quizDone: false,
    quizQuestions: [],
    quizIdx: 0,
    quizScore: 0,
    quizAnswered: false,
    quizSelected: null
};

// ==========================================
// STORAGE
// ==========================================
const STORAGE_KEY = 'ieltsVocabProgress_v3';

function saveState() {
    const data = {
        viewedWords: Array.from(state.viewedWords),
        reviewSchedule: state.reviewSchedule,
        streak: state.streak,
        lastVisit: state.lastVisit
    };
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        showToast('‚ö†Ô∏è B·ªô nh·ªõ ƒë·∫ßy! H√£y xu·∫•t ti·∫øn ƒë·ªô.');
    }
}

function loadState() {
    let raw = localStorage.getItem(STORAGE_KEY);

    if (!raw) {
        const oldRaw = localStorage.getItem('ieltsVocabProgress');
        if (oldRaw) {
            try {
                const old = JSON.parse(oldRaw);
                state.viewedWords = new Set(old.viewedWords || []);
            } catch (e) {}
        }
        return;
    }

    try {
        const data = JSON.parse(raw);
        state.viewedWords    = new Set(data.viewedWords || []);
        state.reviewSchedule = data.reviewSchedule || {};
        state.streak         = typeof data.streak === 'number' ? data.streak : 0;
        state.lastVisit      = data.lastVisit || null;
    } catch (e) {
        console.error('loadState error:', e);
    }
}

function updateStreak() {
    const today = new Date().toDateString();
    if (!state.lastVisit) {
        state.streak    = 1;
        state.lastVisit = today;
        saveState();
        return;
    }
    if (state.lastVisit === today) return;

    const msPerDay = 1000 * 60 * 60 * 24;
    const diffDays = Math.round((new Date() - new Date(state.lastVisit)) / msPerDay);

    state.streak    = diffDays <= 2 ? state.streak + 1 : 1;
    state.lastVisit = today;
    saveState();
}

// ==========================================
// DUE WORDS
// ==========================================
function getDueWords() {
    return Object.keys(state.reviewSchedule).filter(w => isDue(state.reviewSchedule[w]));
}

function buildReviewQueue() {
    const due = getDueWords();
    if (due.length > 0) return due;

    const unreviewed = Array.from(state.viewedWords).filter(w => {
        const s = state.reviewSchedule[w];
        return !s || s.reviewCount === 0;
    });
    return unreviewed.sort(() => Math.random() - 0.5).slice(0, 10);
}

// ==========================================
// AUDIO
// ==========================================
let speechSynthesisVoices = [];

function loadVoices() {
    if ('speechSynthesis' in window) {
        speechSynthesisVoices = window.speechSynthesis.getVoices();
    }
}

function speak(text) {
    if (!('speechSynthesis' in window)) {
        showToast('‚ö†Ô∏è Browser kh√¥ng h·ªó tr·ª£ ph√°t √¢m. Vui l√≤ng d√πng Chrome!');
        return;
    }
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-GB';
    utterance.rate = 0.85;
    if (speechSynthesisVoices.length > 0) {
        const ukVoice = speechSynthesisVoices.find(v =>
            v.lang.includes('GB') && (v.name.includes('Google') || v.name.includes('Female'))
        ) || speechSynthesisVoices.find(v => v.lang.includes('GB'));
        if (ukVoice) utterance.voice = ukVoice;
    }
    window.speechSynthesis.speak(utterance);
}

// ==========================================
// THEME
// ==========================================
function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme === 'dark' ? 'dark' : '');
    localStorage.setItem('theme', newTheme);
}

// ==========================================
// NAVIGATION
// ==========================================
function setView(view) {
    state.currentView = view;

    if (view === 'quiz') {
        state.quizStarted = false; state.quizDone = false;
        state.quizQuestions = []; state.quizIdx = 0;
        state.quizScore = 0; state.quizAnswered = false; state.quizSelected = null;
    }
    if (view === 'review') {
        state.reviewSessionStarted = false;
        state.reviewDone           = false;
        state.reviewQueue          = [];
        state.reviewIdx            = 0;
        state.reviewRevealed       = false;
        state.reviewSessionCount   = 0;
    }

    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === view);
    });
    URLHashManager.update(view, state.currentLesson, state.currentType);
    render();
}

function setLesson(num) {
    state.currentLesson = num;
    URLHashManager.update(state.currentView, state.currentLesson, state.currentType);
    render();
}

function setType(type) {
    state.currentType   = type;
    state.currentPassage = null;
    URLHashManager.update(state.currentView, state.currentLesson, state.currentType);
    render();
}

function setPassage(passageName) {
    state.currentPassage = passageName;
    render();
}

// ==========================================
// DATA HELPERS
// ==========================================

/*
 * FIX: hasNestedPassages checks strictly that first value is a plain object
 * WITHOUT 'ipa' field ‚Äî meaning it's a passage container, not a word entry.
 * This correctly handles:
 *   - Flat:   { "word": { ipa, meaning, ... } }         ‚Üí false
 *   - Nested: { "Passage Title": { "word": { ipa, ... } } } ‚Üí true
 *   - Empty:  {}                                         ‚Üí false
 *
 * The check is applied to the CURRENT category/lesson/type combination,
 * so listening L7 (which is flat) will never show passage selectors.
 */
function hasNestedPassages(category, lesson, type) {
    const data = VOCAB_DATA[category]?.[lesson]?.[type];
    if (!data || Object.keys(data).length === 0) return false;
    const firstVal = data[Object.keys(data)[0]];
    // Must be a plain object AND must NOT have 'ipa' (word entries always have ipa)
    return firstVal !== null &&
           typeof firstVal === 'object' &&
           !Array.isArray(firstVal) &&
           !('ipa' in firstVal);
}

function getCurrentVocabData() {
    const data = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType];
    if (!data) return {};

    if (hasNestedPassages(state.currentView, state.currentLesson, state.currentType)) {
        if (state.currentPassage) return data[state.currentPassage] || {};
        let combined = {};
        Object.values(data).forEach(passage => Object.assign(combined, passage));
        return combined;
    }
    return data;
}

function getAllWordsFromData(data) {
    if (!data || Object.keys(data).length === 0) return [];
    const firstVal = data[Object.keys(data)[0]];
    if (firstVal && 'ipa' in firstVal) return Object.keys(data);
    let words = [];
    Object.values(data).forEach(passage => words.push(...Object.keys(passage)));
    return words;
}

// Find word data anywhere in VOCAB_DATA (used by review queue)
function findWordDataGlobal(word) {
    for (const cat of ['reading', 'listening']) {
        for (const lesson of Object.keys(VOCAB_DATA[cat])) {
            for (const type of ['inclass', 'homework']) {
                const data = VOCAB_DATA[cat][lesson][type];
                if (!data) continue;
                if (hasNestedPassages(cat, parseInt(lesson), type)) {
                    for (const passage of Object.values(data)) {
                        if (passage[word]) return passage[word];
                    }
                } else {
                    if (data[word]) return data[word];
                }
            }
        }
    }
    return null;
}

// ==========================================
// FIX: Safe HTML render for paraphrase
// Paraphrase field may contain <strong>word</strong> to highlight
// the target word in its example sentence. We render this as HTML
// but sanitize by only allowing <strong> tags ‚Äî nothing else.
// ==========================================
function safeParaphraseHTML(text) {
    if (!text) return '';
    // Strip all tags except <strong> and </strong>
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Re-allow only <strong> and </strong>
        .replace(/&lt;strong&gt;/g, '<strong>')
        .replace(/&lt;\/strong&gt;/g, '</strong>');
}

// ==========================================
// STREAK BAR
// ==========================================
function renderStreakBar() {
    const bar = document.getElementById('streakBar');
    if (!bar) return;
    bar.innerHTML = '';

    const fireChip = document.createElement('div');
    fireChip.className = 'streak-chip streak-chip-fire';
    fireChip.textContent = 'üî• ' + state.streak + ' ng√†y';
    bar.appendChild(fireChip);

    const dueCount = getDueWords().length;
    if (dueCount > 0) {
        const dueChip = document.createElement('div');
        dueChip.className = 'streak-chip streak-chip-due';
        dueChip.textContent = 'üîÅ ' + dueCount + ' t·ª´ c·∫ßn √¥n';
        dueChip.addEventListener('click', () => setView('review'));
        bar.appendChild(dueChip);
    }

    const masteredCount = Object.values(state.reviewSchedule).filter(s => s.reviewCount >= 5).length;
    if (masteredCount > 0) {
        const mastChip = document.createElement('div');
        mastChip.className = 'streak-chip streak-chip-mastered';
        mastChip.textContent = '‚≠ê ' + masteredCount + ' th√†nh th·∫°o';
        bar.appendChild(mastChip);
    }
}

// ==========================================
// RENDER DISPATCHER
// ==========================================
function render() {
    renderStreakBar();
    const content = document.getElementById('mainContent');
    if (state.currentView === 'progress') {
        renderProgress(content);
    } else if (state.currentView === 'review') {
        renderReview(content);
    } else if (state.currentView === 'quiz') {
        renderQuiz(content);
    } else {
        renderVocabView(content);
    }
}

// ==========================================
// VOCAB VIEW
// ==========================================
function renderVocabView(container) {
    // Reading: L1‚ÄìL7 (or however many entries exist in VOCAB_DATA.reading)
    // Listening: L1‚ÄìL8 (or however many entries exist in VOCAB_DATA.listening)
    // This reads the actual count from data so Minh only needs to add new lessons
    // to vocab-data.js and the buttons appear automatically.
    const maxLessons = Object.keys(VOCAB_DATA[state.currentView]).length;
    container.innerHTML = '';

    // Lesson selector
    const lessonsDiv = document.createElement('div');
    lessonsDiv.className = 'lesson-grid';
    for (let i = 1; i <= maxLessons; i++) {
        const btn = document.createElement('button');
        btn.className = 'lesson-btn';
        btn.textContent = 'L' + i;
        if (i === state.currentLesson) btn.classList.add('active');
        if (hasLessonProgress(state.currentView, i)) btn.classList.add('has-progress');
        btn.addEventListener('click', () => setLesson(i));
        lessonsDiv.appendChild(btn);
    }
    container.appendChild(lessonsDiv);

    // Type selector
    const typeDiv = document.createElement('div');
    typeDiv.className = 'type-selector';

    const inclassBtn = document.createElement('button');
    inclassBtn.className = 'type-btn' + (state.currentType === 'inclass' ? ' active' : '');
    inclassBtn.textContent = 'In-Class';
    inclassBtn.addEventListener('click', () => setType('inclass'));

    const homeworkBtn = document.createElement('button');
    homeworkBtn.className = 'type-btn' + (state.currentType === 'homework' ? ' active' : '');
    homeworkBtn.textContent = 'Homework';
    homeworkBtn.addEventListener('click', () => setType('homework'));

    typeDiv.appendChild(inclassBtn);
    typeDiv.appendChild(homeworkBtn);
    container.appendChild(typeDiv);

    // Passage selector ‚Äî shown for BOTH reading and listening if data is nested.
    // A lesson is "nested" when its vocab is grouped under passage titles
    // (see hasNestedPassages for the detection logic).
    const rawData = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType];
    if (hasNestedPassages(state.currentView, state.currentLesson, state.currentType) && rawData) {
        const passageDiv = document.createElement('div');
        passageDiv.className = 'passage-selector';

        const allBtn = document.createElement('button');
        allBtn.className = 'passage-btn' + (state.currentPassage === null ? ' active' : '');
        allBtn.textContent = 'üìö All Passages';
        allBtn.addEventListener('click', () => setPassage(null));
        passageDiv.appendChild(allBtn);

        Object.keys(rawData).forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'passage-btn' + (state.currentPassage === name ? ' active' : '');
            btn.textContent = name;
            btn.addEventListener('click', () => setPassage(name));
            passageDiv.appendChild(btn);
        });
        container.appendChild(passageDiv);
    }

    // Stats bar
    const data        = getCurrentVocabData();
    const words       = Object.keys(data);
    const viewedCount   = words.filter(w => state.viewedWords.has(w)).length;
    const masteredCount = words.filter(w => getMastery(state.reviewSchedule[w]) === 'mastered').length;

    const statsDiv = document.createElement('div');
    statsDiv.className = 'stats-bar';
    statsDiv.innerHTML =
        '<div class="stat-card"><div class="stat-value">' + words.length + '</div><div class="stat-label">T·ªïng t·ª´</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + viewedCount + '</div><div class="stat-label">ƒê√£ xem</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + masteredCount + '</div><div class="stat-label">Th√†nh th·∫°o ‚≠ê</div></div>';
    container.appendChild(statsDiv);

    // Vocab grid
    const gridDiv = document.createElement('div');
    if (words.length === 0) {
        gridDiv.className = 'empty-state';
        gridDiv.innerHTML = '<div class="empty-icon">üî≠</div><div class="empty-text">Ch∆∞a c√≥ t·ª´ v·ª±ng cho b√†i n√†y</div>';
    } else {
        gridDiv.className = 'vocab-grid';

        const sorted = [...words].sort((a, b) => {
            const pA = data[a]?.paragraph || 'Z';
            const pB = data[b]?.paragraph || 'Z';
            return pA.localeCompare(pB);
        });

        sorted.forEach(word => {
            const srs     = state.reviewSchedule[word];
            const mastery = getMastery(srs);
            const viewed  = state.viewedWords.has(word);

            const card = document.createElement('div');
            card.className = 'vocab-card';
            if (viewed)                 card.classList.add('viewed');
            if (mastery === 'learning') card.classList.add('card-learning');
            if (mastery === 'mastered') card.classList.add('card-mastered');
            card.dataset.word = word;

            const wordDiv = document.createElement('div');
            wordDiv.className = 'vocab-word';
            wordDiv.textContent = word;
            card.appendChild(wordDiv);

            // Paragraph badge ‚Äî only if word has a paragraph field
            // This ONLY appears for reading passages that have paragraph: "A","B" etc.
            // Listening words without paragraph field will never get this badge.
            if (data[word]?.paragraph) {
                const pbadge = document.createElement('div');
                pbadge.className = 'paragraph-badge';
                pbadge.setAttribute('data-para', data[word].paragraph);
                pbadge.textContent = data[word].paragraph;
                card.appendChild(pbadge);
            }

            // Mastery badge ‚Äî only if viewed
            if (viewed) {
                const mbadge = document.createElement('div');
                mbadge.className = 'mastery-badge mastery-' + mastery;
                mbadge.textContent = mastery === 'new' ? 'M·ªõi' : mastery === 'learning' ? 'ƒêang h·ªçc' : 'Th√†nh th·∫°o ‚≠ê';
                card.appendChild(mbadge);
            }

            gridDiv.appendChild(card);
        });

        gridDiv.addEventListener('click', e => {
            const card = e.target.closest('.vocab-card');
            if (card && card.dataset.word) showWord(card.dataset.word);
        });
    }
    container.appendChild(gridDiv);
}

// ==========================================
// REVIEW VIEW
// ==========================================
function renderReview(container) {
    container.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'review-wrap';

    if (!state.reviewSessionStarted) {
        state.reviewQueue          = buildReviewQueue();
        state.reviewIdx            = 0;
        state.reviewRevealed       = false;
        state.reviewDone           = state.reviewQueue.length === 0;
        state.reviewSessionCount   = 0;
        state.reviewSessionStarted = true;
    }

    // Done / empty state
    if (state.reviewQueue.length === 0 || state.reviewDone) {
        const icon  = state.reviewSessionCount > 0 ? 'üéâ' : '‚ú®';
        const noWords = state.reviewQueue.length === 0 && state.reviewSessionCount === 0;
        const title = state.reviewSessionCount > 0 ? '√în xong r·ªìi!' : (noWords ? 'Ch∆∞a c√≥ t·ª´ ƒë·ªÉ √¥n!' : 'Kh√¥ng c√≥ g√¨ ƒë·ªÉ √¥n!');
        const sub   = state.reviewSessionCount > 0
            ? 'ƒê√£ √¥n ' + state.reviewSessionCount + ' t·ª´. Quay l·∫°i ng√†y mai nh√©!'
            : 'H√£y xem th√™m t·ª´ m·ªõi tr∆∞·ªõc, r·ªìi quay l·∫°i ƒë√¢y √¥n.';

        wrap.innerHTML =
            '<div class="review-done">' +
            '<div class="review-done-icon">' + icon + '</div>' +
            '<div class="review-done-title">' + title + '</div>' +
            '<div class="review-done-sub">' + sub + '</div>' +
            '<div class="review-done-btns"></div>' +
            '</div>';

        const btnsDiv = wrap.querySelector('.review-done-btns');

        if (state.reviewSessionCount > 0) {
            const moreBtn = document.createElement('button');
            moreBtn.className = 'btn btn-primary';
            moreBtn.textContent = 'üîÅ √în th√™m';
            moreBtn.addEventListener('click', () => {
                state.reviewSessionStarted = false;
                state.reviewDone = false;
                render();
            });
            btnsDiv.appendChild(moreBtn);
        }

        const homeBtn = document.createElement('button');
        homeBtn.className = 'btn btn-primary';
        homeBtn.textContent = 'üìñ Reading';
        homeBtn.addEventListener('click', () => setView('reading'));
        btnsDiv.appendChild(homeBtn);

        const listeningBtn = document.createElement('button');
        listeningBtn.className = 'btn btn-ghost';
        listeningBtn.textContent = 'üéß Listening';
        listeningBtn.addEventListener('click', () => setView('listening'));
        btnsDiv.appendChild(listeningBtn);

        container.appendChild(wrap);
        return;
    }

    // Active review card
    const total = state.reviewQueue.length;
    const idx   = state.reviewIdx;
    const word  = state.reviewQueue[idx];
    const wdata = findWordDataGlobal(word);

    if (!wdata) {
        state.reviewIdx++;
        if (state.reviewIdx >= total) state.reviewDone = true;
        render();
        return;
    }

    const srs      = state.reviewSchedule[word] || defaultSRS();
    const pct      = Math.round((idx / total) * 100);
    const nextOk   = Math.round(srs.interval * Math.max(1.3, srs.easeFactor - 0.06));
    const nextEasy = Math.round(srs.interval * srs.easeFactor);

    // Progress bar
    const metaDiv = document.createElement('div');
    metaDiv.className = 'review-meta';
    metaDiv.innerHTML =
        '<span class="review-meta-text">' + (idx + 1) + ' / ' + total + '</span>' +
        '<span class="review-meta-text">üî• ' + state.streak + ' ng√†y</span>';
    wrap.appendChild(metaDiv);

    const progBar = document.createElement('div');
    progBar.className = 'review-prog-bar';
    progBar.innerHTML = '<div class="review-prog-fill" style="width:' + pct + '%"></div>';
    wrap.appendChild(progBar);

    // Card
    const card = document.createElement('div');
    card.className = 'review-card';

    const wordEl = document.createElement('div');
    wordEl.className = 'review-word';
    wordEl.textContent = word;

    const ipaEl = document.createElement('div');
    ipaEl.className = 'review-ipa';
    ipaEl.textContent = wdata.ipa || '';

    // Answer block ‚Äî hidden until revealed
    const answerDiv = document.createElement('div');
    answerDiv.className = 'review-answer';
    answerDiv.id = 'reviewAnswer';

    const hr = document.createElement('hr');
    hr.className = 'review-divider';

    const meaningEl = document.createElement('div');
    meaningEl.className = 'review-meaning';
    meaningEl.textContent = wdata.meaning || '';

    // FIX: use innerHTML with safeParaphraseHTML so <strong>word</strong>
    // renders as bold instead of showing literal tag text
    const paraEl = document.createElement('div');
    paraEl.className = 'review-paraphrase';
    paraEl.innerHTML = safeParaphraseHTML(wdata.paraphrase || '');

    answerDiv.appendChild(hr);
    answerDiv.appendChild(meaningEl);
    answerDiv.appendChild(paraEl);

    card.appendChild(wordEl);
    card.appendChild(ipaEl);
    card.appendChild(answerDiv);
    wrap.appendChild(card);

    // Reveal button
    const revealBtn = document.createElement('button');
    revealBtn.className = 'review-reveal-btn';
    revealBtn.id = 'revealBtn';
    revealBtn.textContent = 'üëÅ Hi·ªán ƒë√°p √°n';
    wrap.appendChild(revealBtn);

    // FIX: Recall question label ‚Äî shown after reveal
    // "Em nh·ªõ ra t·ª´ n√†y c√≥ l√¢u kh√¥ng?"
    const recallQ = document.createElement('div');
    recallQ.className = 'recall-question';
    recallQ.id = 'recallQuestion';
    recallQ.innerHTML = 'Em nh·ªõ ra t·ª´ n√†y <span>c√≥ l√¢u kh√¥ng?</span>';
    wrap.appendChild(recallQ);

    // FIX: Rating buttons ‚Äî renamed from Kh√≥/ƒê∆∞·ª£c/D·ªÖ ‚Üí H∆°i l√¢u / B√¨nh th∆∞·ªùng / R·∫•t nhanh
    const ratingsDiv = document.createElement('div');
    ratingsDiv.className = 'review-ratings';
    ratingsDiv.id = 'reviewRatings';

    const ratings = [
        { cls: 'rating-slow',   emoji: 'üòï', label: 'H∆°i l√¢u',     days: '+1 ng√†y',              val: 0 },
        { cls: 'rating-normal', emoji: 'ü§î', label: 'B√¨nh th∆∞·ªùng', days: '+' + nextOk + ' ng√†y', val: 1 },
        { cls: 'rating-fast',   emoji: 'üòä', label: 'R·∫•t nhanh',   days: '+' + nextEasy + ' ng√†y', val: 2 }
    ];

    ratings.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'rating-btn ' + r.cls;
        btn.dataset.rating = r.val;
        btn.innerHTML =
            '<span class="rating-emoji">' + r.emoji + '</span>' +
            '<span class="rating-label">' + r.label + '</span>' +
            '<span class="rating-days">' + r.days + '</span>';
        ratingsDiv.appendChild(btn);
    });

    wrap.appendChild(ratingsDiv);
    container.appendChild(wrap);

    // Event: reveal
    revealBtn.addEventListener('click', () => {
        state.reviewRevealed = true;
        document.getElementById('reviewAnswer').classList.add('visible');
        document.getElementById('revealBtn').style.display = 'none';
        document.getElementById('recallQuestion').classList.add('visible');
        document.getElementById('reviewRatings').classList.add('visible');
        speak(word);
    });

    // Event: rate
    ratingsDiv.addEventListener('click', e => {
        const btn = e.target.closest('.rating-btn');
        if (!btn) return;
        const rating = parseInt(btn.dataset.rating);

        state.reviewSchedule[word] = calcNextReview(
            state.reviewSchedule[word] || defaultSRS(),
            rating
        );
        state.viewedWords.add(word);
        state.reviewSessionCount++;
        saveState();

        state.reviewIdx++;
        state.reviewRevealed = false;
        if (state.reviewIdx >= state.reviewQueue.length) state.reviewDone = true;
        render();
    });
}


// ==========================================
// QUIZ SYSTEM
// ==========================================
const QUIZ_UNLOCK_MASTERED = 10;
const QUIZ_UNLOCK_STREAK   = 3;
const QUIZ_QUESTION_COUNT  = 10;

function isQuizUnlocked() {
    const mastered = Object.values(state.reviewSchedule).filter(s => s.reviewCount >= 5).length;
    return mastered >= QUIZ_UNLOCK_MASTERED || state.streak >= QUIZ_UNLOCK_STREAK;
}

function buildQuizQuestions() {
    const viewed = Array.from(state.viewedWords).filter(w => findWordDataGlobal(w));
    if (viewed.length < 4) return [];
    const shuffled = viewed.sort(() => Math.random() - 0.5);
    const targets  = shuffled.slice(0, QUIZ_QUESTION_COUNT);
    return targets.map(word => {
        const wdata = findWordDataGlobal(word);
        const others = viewed.filter(w => w !== word);
        const distractors = others.sort(() => Math.random() - 0.5)
            .slice(0, 3).map(w => findWordDataGlobal(w)?.meaning || '???');
        const options = [wdata.meaning, ...distractors].sort(() => Math.random() - 0.5);
        return { word, ipa: wdata.ipa, meaning: wdata.meaning, options, correctIdx: options.indexOf(wdata.meaning) };
    });
}

function renderQuiz(container) {
    container.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'quiz-wrap';
    const mastered   = Object.values(state.reviewSchedule).filter(s => s.reviewCount >= 5).length;
    const viewedCount = state.viewedWords.size;

    // LOCKED
    if (!isQuizUnlocked()) {
        const mPct = Math.min(100, Math.round(mastered / QUIZ_UNLOCK_MASTERED * 100));
        const sPct = Math.min(100, Math.round(state.streak / QUIZ_UNLOCK_STREAK * 100));
        wrap.innerHTML = `<div class="quiz-locked">
            <div class="quiz-locked-icon">üîí</div>
            <div class="quiz-locked-title">Quiz ch∆∞a m·ªü kho√°</div>
            <div class="quiz-locked-sub">ƒê·∫°t m·ªôt trong hai ƒëi·ªÅu ki·ªán ƒë·ªÉ m·ªü:</div>
            <div class="quiz-unlock-bars">
                <div class="quiz-unlock-row">
                    <div class="quiz-unlock-label">‚≠ê Th√†nh th·∫°o</div>
                    <div class="quiz-unlock-bar"><div class="quiz-unlock-fill" style="width:${mPct}%"></div></div>
                    <div class="quiz-unlock-count">${mastered}/${QUIZ_UNLOCK_MASTERED}</div>
                </div>
                <div class="quiz-unlock-row">
                    <div class="quiz-unlock-label">üî• Streak</div>
                    <div class="quiz-unlock-bar"><div class="quiz-unlock-fill" style="width:${sPct}%"></div></div>
                    <div class="quiz-unlock-count">${state.streak}/${QUIZ_UNLOCK_STREAK} ng√†y</div>
                </div>
            </div>
            <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="setView('review')">üîÅ √în t·∫≠p ngay</button>
                <button class="btn btn-ghost" onclick="setView('reading')">üìñ Xem t·ª´ v·ª±ng</button>
            </div>
        </div>`;
        container.appendChild(wrap);
        return;
    }

    // START
    if (!state.quizStarted) {
        wrap.innerHTML = `<div class="quiz-start">
            <div class="quiz-start-icon">üß†</div>
            <div class="quiz-start-title">Ki·ªÉm tra t·ª´ v·ª±ng</div>
            <div class="quiz-start-sub">${QUIZ_QUESTION_COUNT} c√¢u ¬∑ Ch·ªçn ƒë√∫ng nghƒ©a c·ªßa t·ª´<br>
                T·ª´ l·∫•y t·ª´ <strong>${viewedCount}</strong> t·ª´ em ƒë√£ xem</div>
            ${viewedCount >= 4
                ? `<button class="btn btn-primary" style="max-width:280px;margin:0 auto" id="quizStartBtn">üöÄ B·∫Øt ƒë·∫ßu</button>`
                : `<div style="opacity:0.6;font-size:14px">H√£y xem √≠t nh·∫•t 4 t·ª´ tr∆∞·ªõc</div>`}
        </div>`;
        const startBtn = wrap.querySelector('#quizStartBtn');
        if (startBtn) startBtn.addEventListener('click', () => {
            state.quizQuestions = buildQuizQuestions();
            if (!state.quizQuestions.length) { showToast('Kh√¥ng ƒë·ªß t·ª´ ƒë·ªÉ t·∫°o quiz!'); return; }
            state.quizStarted = true; state.quizDone = false;
            state.quizIdx = 0; state.quizScore = 0;
            state.quizAnswered = false; state.quizSelected = null;
            render();
        });
        container.appendChild(wrap);
        return;
    }

    // RESULTS
    if (state.quizDone) {
        const total = state.quizQuestions.length;
        const pct   = Math.round(state.quizScore / total * 100);
        const msgs  = pct >= 90 ? ['üèÜ Xu·∫•t s·∫Øc!','Em ƒë·ªânh th·∫≠t s·ª±!']
                    : pct >= 70 ? ['üëè T·ªët l·∫Øm!','G·∫ßn ho√†n h·∫£o r·ªìi!']
                    : pct >= 50 ? ['üí™ ·ªîn ƒë·∫•y!','√în th√™m ch√∫t n·ªØa nh√©.']
                    :             ['üìö C·∫ßn c·ªë g·∫Øng!','ƒê·ª´ng n·∫£n, √¥n l·∫°i r·ªìi th·ª≠ ti·∫øp!'];
        wrap.innerHTML = `<div class="quiz-results">
            <div class="quiz-results-score">${pct}%</div>
            <div class="quiz-results-label">${state.quizScore}/${total} c√¢u ƒë√∫ng</div>
            <div class="quiz-results-msg">${msgs[0]}</div>
            <div class="quiz-results-sub">${msgs[1]}</div>
            <div class="quiz-results-btns">
                <button class="btn btn-primary" id="quizRetryBtn">üîÑ L√†m l·∫°i</button>
                <button class="btn btn-ghost" onclick="setView('review')">üîÅ √în t·∫≠p</button>
            </div>
        </div>`;
        wrap.querySelector('#quizRetryBtn').addEventListener('click', () => {
            state.quizStarted = false; state.quizDone = false;
            state.quizQuestions = []; state.quizIdx = 0;
            state.quizScore = 0; state.quizAnswered = false; state.quizSelected = null;
            render();
        });
        container.appendChild(wrap);
        return;
    }

    // ACTIVE QUESTION
    const total = state.quizQuestions.length;
    const idx   = state.quizIdx;
    const q     = state.quizQuestions[idx];
    const pct   = Math.round(idx / total * 100);

    const hdr = document.createElement('div');
    hdr.className = 'quiz-header';
    hdr.innerHTML = `<span class="quiz-counter">C√¢u ${idx+1} / ${total}</span>
                     <span class="quiz-score-live">‚úÖ ${state.quizScore} ƒë√∫ng</span>`;
    wrap.appendChild(hdr);

    const pg = document.createElement('div');
    pg.className = 'quiz-prog-bar';
    pg.innerHTML = `<div class="quiz-prog-fill" style="width:${pct}%"></div>`;
    wrap.appendChild(pg);

    const card = document.createElement('div');
    card.className = 'quiz-card';
    card.innerHTML = `<div class="quiz-question-label">T·ª´ n√†y nghƒ©a l√† g√¨?</div>
                      <div class="quiz-question-word">${q.word}</div>
                      <div class="quiz-question-ipa">${q.ipa || ''}</div>`;

    const optsDiv = document.createElement('div');
    optsDiv.className = 'quiz-options';
    const letters = ['A','B','C','D'];

    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-option';
        btn.dataset.idx = i;
        btn.innerHTML = `<span class="quiz-option-letter">${letters[i]}</span><span>${opt}</span>`;
        btn.addEventListener('click', () => {
            if (state.quizAnswered) return;
            state.quizAnswered = true;
            const correct = i === q.correctIdx;
            if (correct) state.quizScore++;
            optsDiv.querySelectorAll('.quiz-option').forEach(b => {
                b.classList.add('disabled');
                const bi = parseInt(b.dataset.idx);
                if (bi === q.correctIdx) b.classList.add('correct');
                else if (bi === i && !correct) b.classList.add('wrong');
            });
            const fb = card.querySelector('.quiz-feedback');
            fb.classList.add('show', correct ? 'correct' : 'wrong');
            fb.textContent = correct ? '‚úÖ Ch√≠nh x√°c!' : '‚ùå Sai! ƒê√°p √°n: ' + q.meaning;
            nextBtn.classList.add('show');
        });
        optsDiv.appendChild(btn);
    });

    const feedback = document.createElement('div');
    feedback.className = 'quiz-feedback';
    card.appendChild(optsDiv);
    card.appendChild(feedback);
    wrap.appendChild(card);

    const nextBtn = document.createElement('button');
    nextBtn.className = 'quiz-next-btn';
    nextBtn.textContent = idx+1 < total ? 'C√¢u ti·∫øp theo ‚Üí' : 'Xem k·∫øt qu·∫£ üèÅ';
    nextBtn.addEventListener('click', () => {
        state.quizIdx++;
        state.quizAnswered = false; state.quizSelected = null;
        if (state.quizIdx >= total) state.quizDone = true;
        render();
    });
    wrap.appendChild(nextBtn);
    container.appendChild(wrap);
}

// ==========================================
// PROGRESS VIEW
// ==========================================
function renderProgress(container) {
    const totalWords      = getTotalWords();
    const viewedWords     = state.viewedWords.size;
    const pct             = totalWords > 0 ? Math.round((viewedWords / totalWords) * 100) : 0;
    const readingTotal    = getCategoryTotal('reading');
    const listeningTotal  = getCategoryTotal('listening');
    const readingViewed   = getCategoryViewed('reading');
    const listeningViewed = getCategoryViewed('listening');
    const readingPct      = readingTotal   > 0 ? Math.round((readingViewed   / readingTotal)   * 100) : 0;
    const listeningPct    = listeningTotal > 0 ? Math.round((listeningViewed / listeningTotal) * 100) : 0;

    const allSRS        = Object.values(state.reviewSchedule);
    const masteredCount = allSRS.filter(s => s.reviewCount >= 5).length;
    const learningCount = allSRS.filter(s => s.reviewCount > 0 && s.reviewCount < 5).length;
    const mastPct       = viewedWords > 0 ? Math.round((masteredCount / viewedWords) * 100) : 0;
    const learnPct      = viewedWords > 0 ? Math.round((learningCount / viewedWords) * 100) : 0;

    container.innerHTML = `
        <div class="progress-container">
            <div class="progress-section">
                <div class="progress-title">üìä Ti·∫øn ƒë·ªô t·ªïng th·ªÉ</div>
                <div class="progress-row">
                    <div class="progress-label">T·ªïng</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${pct}%">${pct}%</div>
                    </div>
                    <div class="progress-count">${viewedWords}/${totalWords}</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-title">üìö Theo lo·∫°i</div>
                <div class="progress-row">
                    <div class="progress-label">üìñ Reading</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${readingPct}%">${readingViewed}/${readingTotal}</div>
                    </div>
                    <div class="progress-count">${readingViewed}</div>
                </div>
                <div class="progress-row">
                    <div class="progress-label">üéß Listening</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${listeningPct}%">${listeningViewed}/${listeningTotal}</div>
                    </div>
                    <div class="progress-count">${listeningViewed}</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-title">‚≠ê Th√†nh th·∫°o</div>
                <div class="progress-row">
                    <div class="progress-label">Th√†nh th·∫°o</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-fill-green" style="width:${mastPct}%">${masteredCount}</div>
                    </div>
                    <div class="progress-count">${masteredCount}</div>
                </div>
                <div class="progress-row">
                    <div class="progress-label">ƒêang h·ªçc</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-fill-amber" style="width:${learnPct}%">${learningCount}</div>
                    </div>
                    <div class="progress-count">${learningCount}</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-title">üíæ Export / Import</div>
                <div class="export-section">
                    <button class="btn btn-primary" id="exportBtn">üì§ Xu·∫•t ti·∫øn ƒë·ªô</button>
                    <button class="btn btn-secondary" id="importBtn">üì• Nh·∫≠p ti·∫øn ƒë·ªô</button>
                </div>
            </div>
        </div>
    `;

    container.querySelector('#exportBtn').addEventListener('click', exportProgress);
    container.querySelector('#importBtn').addEventListener('click', importProgress);
}

// ==========================================
// MODAL (word detail)
// ==========================================
function showWord(word) {
    const vocabData = getCurrentVocabData();
    const data = vocabData[word];
    if (!data) return;

    state.viewedWords.add(word);
    if (!state.reviewSchedule[word]) {
        state.reviewSchedule[word] = defaultSRS();
    }
    saveState();

    state.currentModalWord = word;
    const youglishUrl = 'https://youglish.com/pronounce/' + encodeURIComponent(word) + '/english/uk';

    const content = document.getElementById('modalContent');
    content.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.style.textAlign = 'center';

    const wordElem = document.createElement('div');
    wordElem.className = 'modal-word';
    wordElem.textContent = word;

    const typeElem = document.createElement('span');
    typeElem.className = 'modal-type';
    typeElem.textContent = data.type;

    const ipaElem = document.createElement('div');
    ipaElem.className = 'modal-ipa';
    ipaElem.textContent = data.ipa;

    const meaningElem = document.createElement('div');
    meaningElem.className = 'modal-meaning';
    meaningElem.textContent = data.meaning;

    // FIX: use innerHTML with safeParaphraseHTML so <strong>word</strong>
    // renders correctly instead of showing literal "<strong>" text
    const paraphraseElem = document.createElement('div');
    paraphraseElem.className = 'modal-paraphrase';
    paraphraseElem.innerHTML = safeParaphraseHTML(data.paraphrase);

    wrapper.appendChild(wordElem);
    wrapper.appendChild(typeElem);
    wrapper.appendChild(ipaElem);
    wrapper.appendChild(meaningElem);
    wrapper.appendChild(paraphraseElem);

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'modal-actions';

    const listenBtn = document.createElement('button');
    listenBtn.className = 'btn btn-primary';
    listenBtn.style.cssText = 'font-size:18px; padding:18px 28px;';
    listenBtn.innerHTML = 'üîä Ph√°t √¢m';
    listenBtn.addEventListener('click', () => speak(word));

    const youglishBtn = document.createElement('button');
    youglishBtn.className = 'btn btn-secondary';
    youglishBtn.innerHTML = 'üé¨ B·ªëi c·∫£nh th·ª±c t·∫ø';
    youglishBtn.addEventListener('click', () => {
        // Open after brief delay; use noopener to look less like automation
        const url = 'https://youglish.com/pronounce/' + encodeURIComponent(state.currentModalWord) + '/english/uk';
        window.open(url, '_blank', 'noopener,noreferrer');
    });

    actionsDiv.appendChild(listenBtn);
    actionsDiv.appendChild(youglishBtn);
    content.appendChild(wrapper);
    content.appendChild(actionsDiv);

    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('vocabModal').classList.add('active');
    render();
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('vocabModal').classList.remove('active');
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function hasLessonProgress(category, lesson) {
    const sv = state.currentView, sl = state.currentLesson, st = state.currentType, sp = state.currentPassage;
    state.currentView    = category;
    state.currentLesson  = lesson;
    state.currentPassage = null;

    let found = false;
    for (const type of ['inclass', 'homework']) {
        state.currentType = type;
        const words = Object.keys(getCurrentVocabData());
        if (words.some(w => state.viewedWords.has(w))) { found = true; break; }
    }

    state.currentView = sv; state.currentLesson = sl; state.currentType = st; state.currentPassage = sp;
    return found;
}

function getTotalWords() {
    let total = 0;
    ['reading', 'listening'].forEach(cat => {
        Object.keys(VOCAB_DATA[cat]).forEach(lesson => {
            ['inclass', 'homework'].forEach(type => {
                total += getAllWordsFromData(VOCAB_DATA[cat][lesson][type]).length;
            });
        });
    });
    return total;
}

function getCategoryTotal(category) {
    let total = 0;
    Object.keys(VOCAB_DATA[category]).forEach(lesson => {
        ['inclass', 'homework'].forEach(type => {
            total += getAllWordsFromData(VOCAB_DATA[category][lesson][type]).length;
        });
    });
    return total;
}

function getCategoryViewed(category) {
    let viewed = 0;
    Object.keys(VOCAB_DATA[category]).forEach(lesson => {
        ['inclass', 'homework'].forEach(type => {
            getAllWordsFromData(VOCAB_DATA[category][lesson][type]).forEach(w => {
                if (state.viewedWords.has(w)) viewed++;
            });
        });
    });
    return viewed;
}

function exportProgress() {
    const data = {
        version: 3,
        viewedWords: Array.from(state.viewedWords),
        reviewSchedule: state.reviewSchedule,
        streak: state.streak,
        lastVisit: state.lastVisit,
        exportDate: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'ielts-vocab-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function importProgress() {
    const input    = document.createElement('input');
    input.type     = 'file';
    input.accept   = 'application/json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                state.viewedWords    = new Set(data.viewedWords || []);
                state.reviewSchedule = data.reviewSchedule || {};
                state.streak         = typeof data.streak === 'number' ? data.streak : 0;
                state.lastVisit      = data.lastVisit || null;
                saveState();
                render();
                showToast('‚úÖ Nh·∫≠p ti·∫øn ƒë·ªô th√†nh c√¥ng!');
            } catch (err) {
                showToast('‚ùå File l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function showToast(message) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2500);
}

// ==========================================
// INIT
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    updateStreak();

    const hashState = URLHashManager.load();
    if (hashState) {
        state.currentView = hashState.view;
        if (hashState.lesson) state.currentLesson = hashState.lesson;
        if (hashState.type)   state.currentType   = hashState.type;
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') document.body.setAttribute('data-theme', 'dark');

    if ('speechSynthesis' in window) {
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', closeModal);

    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => setView(btn.dataset.view));
    });

    render();
});
</script>
</body>
</html>
