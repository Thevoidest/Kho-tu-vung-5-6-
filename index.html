<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Vocab Stream</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&family=JetBrains+Mono:wght@500&display=swap');

        :root {
            --bg: #fdfcfa;
            --text: #1a1614;
            --primary: #2d5016;
            --primary-light: #4a7c2e;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --surface: #ffffff;
            --surface-elevated: #f8f7f5;
            --border: #e8e6e3;
            --success: #10b981;
            --error: #ef4444;
            --shadow: rgba(26, 22, 20, 0.08);
        }

        [data-theme="dark"] {
            --bg: #0f0e0d;
            --text: #e8e6e3;
            --primary: #6b9b4d;
            --primary-light: #8bb56a;
            --accent: #fbbf24;
            --accent-light: #fcd34d;
            --surface: #1a1614;
            --surface-elevated: #252220;
            --border: #3a3632;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            font-size: 17px;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(24px, 5vw, 38px);
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -1px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-switch {
            width: 56px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .theme-switch::before {
            content: '‚òÄÔ∏è';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            transition: all 0.3s;
        }

        [data-theme="dark"] .theme-switch::before {
            content: 'üåô';
            left: 30px;
        }

        /* STREAK & STATS BAR */
        .stats-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 140px;
            padding: 16px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text);
            opacity: 0.7;
            margin-top: 4px;
        }

        .stat-card.streak {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-color: var(--accent);
        }

        .stat-card.streak .stat-value,
        .stat-card.streak .stat-label {
            color: white;
        }

        /* NAVIGATION */
        .main-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            background: var(--surface);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .nav-item {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item:not(.active):hover {
            background: var(--surface-elevated);
        }

        /* LESSON GRID */
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .lesson-btn {
            padding: 20px 12px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            text-align: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text);
            position: relative;
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .lesson-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .lesson-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .lesson-btn.has-progress::after {
            content: '‚úì';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* TYPE SELECTOR */
        .type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        .type-btn {
            flex: 1;
            padding: 14px 32px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .type-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* PASSAGE SELECTOR */
        .passage-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .passage-btn {
            padding: 12px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .passage-btn.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        /* BACK BUTTON */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 20px;
            transition: all 0.2s;
            font-family: 'Be Vietnam Pro', sans-serif;
            min-height: 44px;
        }

        .back-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--surface);
        }

        /* VOCAB CARDS */
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .vocab-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            padding-left: 48px;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
            min-height: 72px;
        }

        .vocab-card:not(:has(.paragraph-badge)) {
            padding-left: 18px;
        }

        .vocab-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--primary-light);
        }

        .vocab-card.mastered {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--surface) 0%, rgba(16, 185, 129, 0.05) 100%);
        }

        .vocab-card.learning {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--surface) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .vocab-card.new {
            border-color: var(--border);
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .word-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .mastery-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .mastery-badge.new {
            background: #e5e7eb;
            color: #6b7280;
        }

        .mastery-badge.learning {
            background: #fef3c7;
            color: #d97706;
        }

        .mastery-badge.mastered {
            background: #d1fae5;
            color: #059669;
        }

        .word-meaning {
            font-size: 14px;
            color: var(--text);
            opacity: 0.8;
        }

        /* PARAGRAPH BADGE */
        .paragraph-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .vocab-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--surface);
            border-radius: 20px;
            padding: 28px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        .vocab-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface-elevated);
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border);
            transform: rotate(90deg);
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .word-group {
            flex: 1;
        }

        .modal-word {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .modal-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            color: var(--text);
            opacity: 0.7;
        }

        .modal-type {
            padding: 6px 12px;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .modal-meaning {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            padding: 16px;
            background: var(--surface-elevated);
            border-radius: 12px;
        }

        .modal-paraphrase {
            font-size: 16px;
            line-height: 1.7;
            color: var(--text);
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--surface-elevated);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .voice-selector {
            display: flex;
            gap: 8px;
        }

        .voice-selector .btn {
            flex: 1;
        }

        /* REVIEW MODE */
        .review-mode {
            max-width: 700px;
            margin: 0 auto;
        }

        .review-card {
            background: var(--surface);
            border: 3px solid var(--border);
            border-radius: 20px;
            padding: 40px 28px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .review-word {
            font-size: 42px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .review-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            color: var(--text);
            opacity: 0.6;
            margin-bottom: 32px;
        }

        .review-content {
            font-size: 18px;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 32px;
            padding: 24px;
            background: var(--surface-elevated);
            border-radius: 16px;
        }

        .review-content.hidden {
            filter: blur(12px);
            user-select: none;
            pointer-events: none;
        }

        /* Rating section with label */
        .rating-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
            align-items: center;
        }

        .rating-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            opacity: 0.55;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .review-actions {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .review-actions .btn {
            flex: 1;
        }

        .reveal-btn {
            background: var(--accent);
            color: white;
            font-size: 18px;
        }

        .reveal-btn:hover {
            background: var(--accent-light);
        }

        /* QUIZ */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quiz-card {
            background: var(--surface);
            border: 3px solid var(--primary);
            border-radius: 20px;
            padding: 32px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .quiz-progress {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }

        .quiz-question {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 24px;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            text-align: left;
            min-height: 44px;
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        .quiz-option:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .quiz-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .quiz-option.incorrect {
            border-color: var(--error);
            background: var(--error);
            color: white;
        }

        .quiz-result {
            text-align: center;
            padding: 40px 20px;
        }

        .quiz-score {
            font-size: 64px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .quiz-message {
            font-size: 20px;
            color: var(--text);
            margin-bottom: 32px;
        }

        /* FEEDBACK BUTTON */
        .feedback-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 900;
        }

        .feedback-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        }

        .feedback-modal {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 340px;
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 901;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s;
        }

        .feedback-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .feedback-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .feedback-reactions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .feedback-reaction {
            flex: 1;
            padding: 12px;
            background: var(--surface-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            text-align: center;
            transition: all 0.2s;
        }

        .feedback-reaction:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .feedback-reaction.selected {
            border-color: var(--primary);
            background: var(--primary);
        }

        .feedback-text {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--surface-elevated);
            color: var(--text);
            font-family: 'Be Vietnam Pro', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .feedback-text:focus {
            outline: none;
            border-color: var(--primary);
        }

        .feedback-submit {
            width: 100%;
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: var(--bg);
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 15px;
            color: var(--text);
            opacity: 0.6;
        }

        /* LOCKED BADGE */
        .locked-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            opacity: 0.3;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            .stats-bar {
                gap: 8px;
            }

            .stat-card {
                min-width: 100px;
                padding: 12px 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .vocab-grid {
                grid-template-columns: 1fr;
            }

            .review-card {
                padding: 28px 20px;
                min-height: 350px;
            }

            .review-word {
                font-size: 36px;
            }

            .feedback-modal {
                right: 16px;
                left: 16px;
                width: auto;
            }

            .feedback-fab {
                right: 16px;
                bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">IELTS Vocab</div>
            <div class="header-controls">
                <div class="theme-switch" id="themeToggle"></div>
            </div>
        </header>

        <div class="stats-bar" id="statsBar"></div>
        <div class="main-nav" id="mainNav"></div>
        <div id="appContent"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="vocab-modal" id="vocabModal">
        <button class="modal-close" id="modalClose">√ó</button>
        <div id="modalContent"></div>
    </div>

    <button class="feedback-fab" id="feedbackBtn">üí¨</button>
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-title">B·∫°n th·∫•y app th·∫ø n√†o?</div>
        <div class="feedback-reactions">
            <button class="feedback-reaction" data-reaction="good">üòä</button>
            <button class="feedback-reaction" data-reaction="ok">ü§î</button>
            <button class="feedback-reaction" data-reaction="bad">üòï</button>
        </div>
        <textarea class="feedback-text" id="feedbackText" placeholder="Vi·∫øt th√™m √Ω ki·∫øn... (optional)"></textarea>
        <button class="btn btn-primary feedback-submit" id="feedbackSubmit">G·ª≠i ·∫©n danh</button>
    </div>

    <script src="vocab-data.js"></script>
    <script src="quiz-data.js"></script>
    <script>
        const VERSION = '2.0.1';
        
        const CONFIG = {
            DAILY_GOAL: 10,
            QUICK_REVIEW_COUNT: 5,
            QUIZ_UNLOCK_REQUIREMENT: 50,
            SPACED_INTERVALS: {
                easy: [1, 3, 7, 14, 30],
                medium: [1, 2, 4, 8, 16],
                hard: [1, 1, 2, 4, 8]
            },
            MASTERY_THRESHOLDS: {
                new: 0,
                learning: 2,
                mastered: 5
            },
            GOOGLE_FORM_URL: '',
            PARAGRAPH_COLORS: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4']
        };

        const FEATURES = {
            STREAK_COUNTER: true,
            SPACED_REPETITION: true,
            QUIZ: true,
            ANALYTICS: true,
            DEBUG: false
        };

        const state = {
            currentView: 'reading',
            currentLesson: null,
            currentType: 'inclass',
            currentPassage: null,
            currentMode: 'browse',
            userId: localStorage.getItem('userId') || crypto.randomUUID(),
            viewedWords: new Set(),
            reviewSchedule: {},
            lastVisit: null,
            streak: 0,
            quizProgress: {},
            analytics: {
                sessionStart: Date.now(),
                clicks: [],
                totalSessions: 0
            }
        };

        let currentVoiceRegion = 'UK';
        let voices = [];
        let hasUKVoice = false;
        let hasUSVoice = false;
        let WORD_INDEX = null;

        function log(...args) {
            if (FEATURES.DEBUG) console.log('[DEBUG]', ...args);
        }

        function saveState() {
            const data = {
                userId: state.userId,
                viewedWords: Array.from(state.viewedWords),
                reviewSchedule: state.reviewSchedule,
                lastVisit: new Date().toISOString(),
                streak: state.streak,
                quizProgress: state.quizProgress,
                analytics: state.analytics
            };
            
            try {
                const jsonData = JSON.stringify(data);
                const sizeKB = new Blob([jsonData]).size / 1024;
                
                if (sizeKB > 4000) {
                    log('Storage near limit:', sizeKB, 'KB');
                    state.analytics.clicks = state.analytics.clicks.slice(-50);
                }
                
                localStorage.setItem('ieltsVocabState', jsonData);
                localStorage.setItem('userId', state.userId);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ùå B·ªô nh·ªõ ƒë·∫ßy! Vui l√≤ng export ti·∫øn ƒë·ªô.');
                    state.analytics.clicks = [];
                    exportProgress();
                } else {
                    console.error('Save error:', e);
                }
            }
        }

        function loadState() {
            const saved = localStorage.getItem('ieltsVocabState');
            if (saved) {
                const data = JSON.parse(saved);
                state.viewedWords = new Set(data.viewedWords || []);
                state.reviewSchedule = data.reviewSchedule || {};
                state.lastVisit = data.lastVisit;
                state.streak = data.streak || 0;
                state.quizProgress = data.quizProgress || {};
                state.analytics = data.analytics || state.analytics;
                updateStreak();
            }
        }

        function updateStreak() {
            if (!state.lastVisit) {
                state.streak = 1;
                return;
            }
            const lastVisit = new Date(state.lastVisit);
            const now = new Date();
            const diffHours = (now - lastVisit) / (1000 * 60 * 60);
            
            if (diffHours < 24) {
                // Same day, maintain streak
            } else if (diffHours < 48) {
                state.streak++;
            } else {
                state.streak = 1;
            }
            saveState();
        }

        function trackEvent(event, data = {}) {
            if (!FEATURES.ANALYTICS) return;
            
            const eventData = {
                userId: state.userId,
                event: event,
                timestamp: new Date().toISOString(),
                ...data
            };
            
            state.analytics.clicks.push(eventData);
            
            if (CONFIG.GOOGLE_FORM_URL && state.analytics.clicks.length >= 10) {
                sendAnalytics();
            }
        }

        function sendAnalytics() {
            if (!CONFIG.GOOGLE_FORM_URL) return;
            
            state.analytics.clicks.forEach(event => {
                const params = new URLSearchParams(event);
                fetch(`${CONFIG.GOOGLE_FORM_URL}?${params}`, { mode: 'no-cors' });
            });
            
            state.analytics.clicks = [];
            saveState();
        }

        function scheduleNextReview(word, difficulty) {
            const intervals = CONFIG.SPACED_INTERVALS[difficulty];
            const currentSchedule = state.reviewSchedule[word] || { reviewCount: 0 };
            const nextInterval = intervals[Math.min(currentSchedule.reviewCount, intervals.length - 1)];
            
            const nextReview = new Date();
            nextReview.setDate(nextReview.getDate() + nextInterval);
            
            state.reviewSchedule[word] = {
                lastReviewed: new Date().toISOString(),
                nextReview: nextReview.toISOString(),
                interval: nextInterval,
                reviewCount: currentSchedule.reviewCount + 1,
                difficulty: difficulty
            };
            
            saveState();
            log('Scheduled review for', word, 'in', nextInterval, 'days');
        }

        function getWordMastery(word) {
            const schedule = state.reviewSchedule[word];
            if (!schedule) return 'new';
            
            if (schedule.reviewCount >= CONFIG.MASTERY_THRESHOLDS.mastered) return 'mastered';
            if (schedule.reviewCount >= CONFIG.MASTERY_THRESHOLDS.learning) return 'learning';
            return 'new';
        }

        function getWordsForReview() {
            const now = new Date();
            const dueWords = [];
            
            Object.keys(state.reviewSchedule).forEach(word => {
                const schedule = state.reviewSchedule[word];
                const nextReview = new Date(schedule.nextReview);
                if (nextReview <= now) {
                    dueWords.push(word);
                }
            });
            
            return dueWords;
        }

        function getWeakWords() {
            const weakWords = [];
            
            Object.keys(state.reviewSchedule).forEach(word => {
                const schedule = state.reviewSchedule[word];
                if (schedule.difficulty === 'hard' || schedule.reviewCount < 3) {
                    weakWords.push(word);
                }
            });
            
            return weakWords;
        }

        function renderStatsBar() {
            const totalWords = getTotalWords();
            const viewedCount = state.viewedWords.size;
            const masteredCount = Array.from(state.viewedWords).filter(w => getWordMastery(w) === 'mastered').length;
            const dueCount = getWordsForReview().length;
            
            const html = `
                <div class="stat-card streak">
                    <span class="stat-value">üî• ${state.streak}</span>
                    <span class="stat-label">${state.streak === 1 ? 'ng√†y' : 'ng√†y li√™n ti·∫øp'}</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${viewedCount}</span>
                    <span class="stat-label">t·ª´ ƒë√£ xem</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${masteredCount}</span>
                    <span class="stat-label">th√†nh th·∫°o</span>
                </div>
                ${dueCount > 0 ? `
                <div class="stat-card" style="cursor: pointer;" onclick="setMode('review')">
                    <span class="stat-value" style="color: var(--accent);">${dueCount}</span>
                    <span class="stat-label">c·∫ßn √¥n h√¥m nay</span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('statsBar').innerHTML = html;
        }

        function renderNav() {
            const views = [
                { id: 'reading', label: 'Reading', icon: 'üìñ' },
                { id: 'listening', label: 'Listening', icon: 'üéß' },
                { id: 'review', label: 'Quick Review', icon: '‚ö°' },
                { id: 'quiz', label: 'Quiz', icon: 'üéØ' }
            ];
            
            const html = views.map(view => `
                <button class="nav-item ${state.currentMode === view.id ? 'active' : ''}" 
                        data-view="${view.id}"
                        onclick="setMode('${view.id}')">
                    ${view.icon} ${view.label}
                </button>
            `).join('');
            
            document.getElementById('mainNav').innerHTML = html;
        }

        function setMode(mode) {
            state.currentMode = mode;
            trackEvent('mode_change', { mode });
            render();
        }

        function setView(view) {
            state.currentView = view;
            state.currentLesson = null;
            trackEvent('view_change', { view });
            render();
        }

        function setLesson(lesson) {
            state.currentLesson = lesson;
            state.currentPassage = null;
            trackEvent('lesson_select', { lesson });
            render();
        }

        function setType(type) {
            state.currentType = type;
            trackEvent('type_select', { type });
            render();
        }

        function setPassage(passage) {
            state.currentPassage = passage;
            trackEvent('passage_select', { passage });
            render();
        }

        function getCurrentVocabData() {
            if (!state.currentLesson) return {};
            
            const data = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType] || {};
            
            if (state.currentPassage && data[state.currentPassage]) {
                return data[state.currentPassage];
            }
            
            return data;
        }

        function renderBrowseMode() {
            let html = '';
            const lessons = Object.keys(VOCAB_DATA[state.currentView] || {});

            // Always show lesson grid
            html += '<div class="lesson-grid">';
            lessons.forEach(lesson => {
                const hasProgress = hasLessonProgress(state.currentView, parseInt(lesson));
                const isActive = state.currentLesson == lesson;
                html += `
                    <button class="lesson-btn ${hasProgress ? 'has-progress' : ''} ${isActive ? 'active' : ''}"
                            onclick="setLesson(${state.currentLesson == lesson ? null : lesson})">
                        Lesson ${lesson}
                    </button>
                `;
            });
            html += '</div>';

            // Expand vocab inline below the grid when a lesson is selected
            if (state.currentLesson) {
                html += `<div class="type-selector">
                    <button class="type-btn ${state.currentType === 'inclass' ? 'active' : ''}"
                            onclick="setType('inclass')">
                        In Class
                    </button>
                    <button class="type-btn ${state.currentType === 'homework' ? 'active' : ''}"
                            onclick="setType('homework')">
                        Homework
                    </button>
                </div>`;

                const vocabData = VOCAB_DATA[state.currentView]?.[state.currentLesson]?.[state.currentType] || {};
                const firstKey = Object.keys(vocabData)[0];
                const isNested = firstKey && vocabData[firstKey] && !vocabData[firstKey].ipa;

                if (isNested) {
                    html += '<div class="passage-selector">';
                    Object.keys(vocabData).forEach(passageName => {
                        html += `
                            <button class="passage-btn ${state.currentPassage === passageName ? 'active' : ''}"
                                    onclick="setPassage('${passageName}')">
                                ${passageName}
                            </button>
                        `;
                    });
                    html += '</div>';

                    if (!state.currentPassage) {
                        state.currentPassage = firstKey;
                    }
                }

                const words = getCurrentVocabData();

                if (Object.keys(words).length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">üìö</div>
                            <div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div>
                            <div class="empty-desc">Lesson n√†y ch∆∞a c√≥ t·ª´ v·ª±ng.</div>
                        </div>
                    `;
                } else {
                    html += '<div class="vocab-grid">';
                    Object.keys(words).forEach((word) => {
                        const data = words[word];
                        const mastery = getWordMastery(word);
                        const masteryLabel = mastery === 'new' ? 'M·ªõi' : mastery === 'learning' ? 'ƒêang h·ªçc' : 'Th√†nh th·∫°o';

                        const paragraph = data.paragraph;
                        const colorIndex = paragraph ? paragraph.charCodeAt(0) % CONFIG.PARAGRAPH_COLORS.length : 0;

                        html += `
                            <div class="vocab-card ${mastery}" onclick="openModal('${word}')">
                                ${paragraph ? `<div class="paragraph-badge" style="background: ${CONFIG.PARAGRAPH_COLORS[colorIndex]}">${paragraph}</div>` : ''}
                                <div class="word-header">
                                    <div class="word-title">${word}</div>
                                    <div class="mastery-badge ${mastery}">${masteryLabel}</div>
                                </div>
                                <div class="word-meaning">${data.meaning}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            return html;
        }

        function renderReviewMode() {
            const dueWords = getWordsForReview();
            const weakWords = getWeakWords();
            const allWords = Array.from(state.viewedWords);
            
            let reviewWords = dueWords.length > 0 ? dueWords : 
                             weakWords.length > 0 ? weakWords.slice(0, CONFIG.QUICK_REVIEW_COUNT) :
                             allWords.slice(0, CONFIG.QUICK_REVIEW_COUNT);
            
            if (reviewWords.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-title">Ch∆∞a c√≥ t·ª´ ƒë·ªÉ √¥n!</div>
                        <div class="empty-desc">H·ªçc v√†i t·ª´ m·ªõi tr∆∞·ªõc, r·ªìi quay l·∫°i ƒë√¢y nh√©.</div>
                        <button class="btn btn-primary" onclick="setMode('reading')" style="margin-top: 20px;">
                            H·ªçc t·ª´ m·ªõi
                        </button>
                    </div>
                `;
            }
            
            if (!state.reviewState) {
                state.reviewState = {
                    words: reviewWords,
                    currentIndex: 0,
                    revealed: false,
                    results: []
                };
            }
            
            if (state.reviewState.currentIndex >= state.reviewState.words.length) {
                const correct = state.reviewState.results.filter(r => r === 'easy').length;
                const total = state.reviewState.results.length;
                
                const html = `
                    <div class="review-mode">
                        <div class="review-card">
                            <div class="empty-icon">üéâ</div>
                            <div class="empty-title">Ho√†n th√†nh!</div>
                            <div class="empty-desc">B·∫°n ƒë√£ √¥n xong ${total} t·ª´.</div>
                            <div class="review-actions" style="margin-top: 24px;">
                                <button class="btn btn-primary" onclick="resetReview()">
                                    V·ªÅ trang ch·ªß
                                </button>
                                <button class="btn btn-secondary" onclick="startNewReview()">
                                    √în th√™m
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return html;
            }
            
            const currentWord = state.reviewState.words[state.reviewState.currentIndex];
            const wordData = findWordData(currentWord);
            
            if (!wordData) {
                state.reviewState.currentIndex++;
                return renderReviewMode();
            }
            
            const html = `
                <div class="review-mode">
                    <div style="text-align: center; margin-bottom: 16px; color: var(--text); opacity: 0.6;">
                        ${state.reviewState.currentIndex + 1} / ${state.reviewState.words.length}
                    </div>
                    <div class="review-card">
                        <div class="review-word">${currentWord}</div>
                        <div class="review-ipa">${wordData.ipa}</div>
                        <div class="review-content ${state.reviewState.revealed ? '' : 'hidden'}">
                            <div style="font-weight: 600; margin-bottom: 12px;">${wordData.meaning}</div>
                            <div>${wordData.paraphrase}</div>
                        </div>
                        ${!state.reviewState.revealed ? `
                            <button class="btn reveal-btn" onclick="revealAnswer()">
                                Hi·ªán ƒë√°p √°n
                            </button>
                        ` : `
                            <div class="rating-section">
                                <span class="rating-label">Nh·ªõ ra t·ª´ n√†y c√≥ kh√≥ kh√¥ng?</span>
                                <div class="review-actions">
                                    <button class="btn btn-secondary" onclick="rateWord('hard')">
                                        üòï Kh√° kh√≥
                                    </button>
                                    <button class="btn btn-secondary" onclick="rateWord('medium')">
                                        ü§î B√¨nh th∆∞·ªùng
                                    </button>
                                    <button class="btn btn-primary" onclick="rateWord('easy')">
                                        üòä Tho·∫£i m√°i
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            return html;
        }

        function revealAnswer() {
            state.reviewState.revealed = true;
            const currentWord = state.reviewState.words[state.reviewState.currentIndex];
            speak(currentWord);
            render();
        }

        function rateWord(difficulty) {
            const currentWord = state.reviewState.words[state.reviewState.currentIndex];
            scheduleNextReview(currentWord, difficulty);
            state.reviewState.results.push(difficulty);
            state.reviewState.currentIndex++;
            state.reviewState.revealed = false;
            trackEvent('review_rate', { word: currentWord, difficulty });
            render();
        }

        function resetReview() {
            state.reviewState = null;
            setMode('reading');
        }

        function startNewReview() {
            state.reviewState = null;
            setMode('review');
        }

        function renderQuizMode() {
            const masteredCount = Array.from(state.viewedWords).filter(w => getWordMastery(w) === 'mastered').length;
            const isUnlocked = masteredCount >= CONFIG.QUIZ_UNLOCK_REQUIREMENT || state.streak >= 3;
            
            if (!isUnlocked) {
                return `
                    <div class="empty-state">
                        <div class="locked-badge">üîí</div>
                        <div class="empty-title">Quiz ch∆∞a m·ªü kh√≥a</div>
                        <div class="empty-desc">
                            C·∫ßn ${CONFIG.QUIZ_UNLOCK_REQUIREMENT} t·ª´ th√†nh th·∫°o ho·∫∑c streak 3 ng√†y.<br>
                            Hi·ªán t·∫°i: ${masteredCount} t·ª´ th√†nh th·∫°o, ${state.streak} ng√†y streak.
                        </div>
                        <button class="btn btn-primary" onclick="setMode('reading')" style="margin-top: 20px;">
                            Ti·∫øp t·ª•c h·ªçc
                        </button>
                    </div>
                `;
            }
            
            if (!state.quizState) {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">üéØ</div>
                        <div class="empty-title">S·∫µn s√†ng ki·ªÉm tra?</div>
                        <div class="empty-desc">10 c√¢u h·ªèi tr·∫Øc nghi·ªám t·ª´ v·ª±ng</div>
                        <button class="btn btn-primary" onclick="startQuiz()" style="margin-top: 20px;">
                            B·∫Øt ƒë·∫ßu Quiz
                        </button>
                    </div>
                `;
            }
            
            if (state.quizState.finished) {
                const score = Math.round((state.quizState.correct / state.quizState.questions.length) * 100);
                let message = '';
                if (score >= 90) message = 'Xu·∫•t s·∫Øc! üéâ';
                else if (score >= 70) message = 'T·ªët l·∫Øm! üëè';
                else if (score >= 50) message = '·ªîn ƒë·∫•y! üí™';
                else message = 'C·∫ßn c·ªë g·∫Øng th√™m! üìö';
                
                return `
                    <div class="quiz-container">
                        <div class="quiz-result">
                            <div class="quiz-score">${score}%</div>
                            <div class="quiz-message">${message}</div>
                            <div style="margin-bottom: 24px; color: var(--text); opacity: 0.7;">
                                ${state.quizState.correct} / ${state.quizState.questions.length} c√¢u ƒë√∫ng
                            </div>
                            <div class="review-actions">
                                <button class="btn btn-primary" onclick="resetQuiz()">
                                    L√†m l·∫°i
                                </button>
                                <button class="btn btn-secondary" onclick="setMode('reading')">
                                    V·ªÅ trang ch·ªß
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const currentQ = state.quizState.questions[state.quizState.currentIndex];
            
            let html = `
                <div class="quiz-container">
                    <div class="quiz-card">
                        <div class="quiz-header">
                            <div class="quiz-progress">
                                C√¢u ${state.quizState.currentIndex + 1} / ${state.quizState.questions.length}
                            </div>
                            <div style="color: var(--success); font-weight: 600;">
                                ‚úì ${state.quizState.correct}
                            </div>
                        </div>
                        <div class="quiz-question">${currentQ.question}</div>
                        <div class="quiz-options">
            `;
            
            currentQ.options.forEach((option, index) => {
                let className = 'quiz-option';
                if (state.quizState.answered) {
                    if (index === currentQ.correct) className += ' correct';
                    else if (index === state.quizState.selectedAnswer && index !== currentQ.correct) {
                        className += ' incorrect';
                    }
                } else if (index === state.quizState.selectedAnswer) {
                    className += ' selected';
                }
                
                html += `
                    <button class="${className}" 
                            onclick="selectQuizAnswer(${index})"
                            ${state.quizState.answered ? 'disabled' : ''}>
                        ${option}
                    </button>
                `;
            });
            
            html += `
                        </div>
                        ${state.quizState.answered ? `
                            <button class="btn btn-primary" onclick="nextQuizQuestion()" style="margin-top: 24px;">
                                C√¢u ti·∫øp theo
                            </button>
                        ` : `
                            <button class="btn btn-primary" 
                                    onclick="submitQuizAnswer()"
                                    ${state.quizState.selectedAnswer === null ? 'disabled' : ''}
                                    style="margin-top: 24px;">
                                X√°c nh·∫≠n
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            return html;
        }

        function startQuiz() {
            const allWords = Array.from(state.viewedWords);
            if (allWords.length < 10) {
                showToast('C·∫ßn √≠t nh·∫•t 10 t·ª´ ƒë√£ h·ªçc ƒë·ªÉ l√†m quiz');
                return;
            }
            
            const selectedWords = shuffleArray(allWords).slice(0, 10);
            const questions = selectedWords.map(word => {
                const wordData = findWordData(word);
                if (!wordData) return null;
                
                const quizQ = QUIZ_DATA[word];
                if (quizQ && quizQ.length > 0) {
                    const randomQ = quizQ[Math.floor(Math.random() * quizQ.length)];
                    const correctAnswer = randomQ.options[randomQ.correct];
                    const shuffledOptions = shuffleArray(randomQ.options);
                    const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
                    
                    return {
                        ...randomQ,
                        options: shuffledOptions,
                        correct: newCorrectIndex
                    };
                }
                
                return null;
            }).filter(q => q !== null);
            
            if (questions.length < 5) {
                showToast('Kh√¥ng ƒë·ªß c√¢u h·ªèi ƒë·ªÉ t·∫°o quiz');
                return;
            }
            
            state.quizState = {
                questions: questions,
                currentIndex: 0,
                selectedAnswer: null,
                answered: false,
                correct: 0,
                finished: false
            };
            
            trackEvent('quiz_start');
            render();
        }

        function selectQuizAnswer(index) {
            if (state.quizState.answered) return;
            state.quizState.selectedAnswer = index;
            render();
        }

        function submitQuizAnswer() {
            if (state.quizState.selectedAnswer === null) return;
            
            const currentQ = state.quizState.questions[state.quizState.currentIndex];
            const isCorrect = state.quizState.selectedAnswer === currentQ.correct;
            
            if (isCorrect) {
                state.quizState.correct++;
            }
            
            state.quizState.answered = true;
            trackEvent('quiz_answer', { correct: isCorrect });
            render();
        }

        function nextQuizQuestion() {
            state.quizState.currentIndex++;
            state.quizState.selectedAnswer = null;
            state.quizState.answered = false;
            
            if (state.quizState.currentIndex >= state.quizState.questions.length) {
                state.quizState.finished = true;
                trackEvent('quiz_complete', { score: state.quizState.correct });
            }
            
            render();
        }

        function resetQuiz() {
            state.quizState = null;
            render();
        }

        function render() {
            renderStatsBar();
            renderNav();
            
            let content = '';
            
            if (state.currentMode === 'review') {
                content = renderReviewMode();
            } else if (state.currentMode === 'quiz') {
                content = renderQuizMode();
            } else {
                content = renderBrowseMode();
            }
            
            document.getElementById('appContent').innerHTML = content;
        }

        function buildWordIndex() {
            if (WORD_INDEX) return;
            
            WORD_INDEX = {};
            
            for (let category in VOCAB_DATA) {
                for (let lesson in VOCAB_DATA[category]) {
                    for (let type in VOCAB_DATA[category][lesson]) {
                        const data = VOCAB_DATA[category][lesson][type];
                        
                        Object.keys(data).forEach(key => {
                            if (data[key].ipa) {
                                WORD_INDEX[key] = data[key];
                            } else {
                                Object.keys(data[key]).forEach(word => {
                                    WORD_INDEX[word] = data[key][word];
                                });
                            }
                        });
                    }
                }
            }
            
            log('Word index built:', Object.keys(WORD_INDEX).length, 'words');
        }

        function findWordData(word) {
            if (!WORD_INDEX) buildWordIndex();
            return WORD_INDEX[word] || null;
        }

        function openModal(word) {
            const data = findWordData(word);
            if (!data) return;
            
            state.viewedWords.add(word);
            
            if (!state.reviewSchedule[word]) {
                scheduleNextReview(word, 'medium');
            }
            
            trackEvent('word_view', { word });
            saveState();
            
            const youglishUrl = `https://youglish.com/pronounce/${encodeURIComponent(word)}/english`;
            
            const content = document.getElementById('modalContent');
            content.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'modal-content';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'modal-header';
            
            const wordGroup = document.createElement('div');
            wordGroup.className = 'word-group';
            
            const wordElem = document.createElement('div');
            wordElem.className = 'modal-word';
            wordElem.textContent = word;
            
            const ipaElem = document.createElement('div');
            ipaElem.className = 'modal-ipa';
            ipaElem.textContent = data.ipa;
            
            const typeElem = document.createElement('div');
            typeElem.className = 'modal-type';
            typeElem.textContent = abbreviateType(data.type);
            
            wordGroup.appendChild(wordElem);
            wordGroup.appendChild(ipaElem);
            headerDiv.appendChild(wordGroup);
            headerDiv.appendChild(typeElem);
            
            const meaningElem = document.createElement('div');
            meaningElem.className = 'modal-meaning';
            meaningElem.innerHTML = data.meaning;
            
            const paraphraseElem = document.createElement('div');
            paraphraseElem.className = 'modal-paraphrase';
            paraphraseElem.innerHTML = data.paraphrase;
            
            wrapper.appendChild(headerDiv);
            wrapper.appendChild(meaningElem);
            wrapper.appendChild(paraphraseElem);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'modal-actions';

            // Voice buttons - only show what's available on this device
            const voiceSelector = document.createElement('div');
            voiceSelector.className = 'voice-selector';

            if (hasUKVoice || hasUSVoice) {
                if (hasUKVoice) {
                    const ukBtn = document.createElement('button');
                    ukBtn.className = 'btn ' + (currentVoiceRegion === 'UK' ? 'btn-primary' : 'btn-secondary');
                    ukBtn.innerHTML = 'üá¨üáß UK';
                    ukBtn.addEventListener('click', () => {
                        currentVoiceRegion = 'UK';
                        speak(word);
                        trackEvent('voice_click', { region: 'UK' });
                        updateVoiceBtns(ukBtn, usBtn);
                    });
                    voiceSelector.appendChild(ukBtn);
                    var ukBtnRef = ukBtn;
                }

                if (hasUSVoice) {
                    const usBtn = document.createElement('button');
                    usBtn.className = 'btn ' + (currentVoiceRegion === 'US' ? 'btn-primary' : 'btn-secondary');
                    usBtn.innerHTML = 'üá∫üá∏ US';
                    usBtn.addEventListener('click', () => {
                        currentVoiceRegion = 'US';
                        speak(word);
                        trackEvent('voice_click', { region: 'US' });
                        updateVoiceBtns(ukBtnRef, usBtn);
                    });
                    voiceSelector.appendChild(usBtn);
                    var usBtnRef = usBtn;
                }

                function updateVoiceBtns(ukB, usB) {
                    if (ukB) ukB.className = 'btn ' + (currentVoiceRegion === 'UK' ? 'btn-primary' : 'btn-secondary');
                    if (usB) usB.className = 'btn ' + (currentVoiceRegion === 'US' ? 'btn-primary' : 'btn-secondary');
                }
            } else {
                // Fallback: single pronunciation button using whatever voice is available
                const speakBtn = document.createElement('button');
                speakBtn.className = 'btn btn-primary';
                speakBtn.innerHTML = 'üîä Ph√°t √¢m';
                speakBtn.addEventListener('click', () => {
                    speak(word);
                    trackEvent('voice_click', { region: 'default' });
                });
                voiceSelector.appendChild(speakBtn);
            }
            
            const youglishBtn = document.createElement('button');
            youglishBtn.className = 'btn btn-secondary';
            youglishBtn.innerHTML = 'üé¨ B·ªëi c·∫£nh th·ª±c t·∫ø';
            youglishBtn.addEventListener('click', () => {
                trackEvent('youglish_click');
                window.open(youglishUrl, '_blank');
            });
            
            actionsDiv.appendChild(voiceSelector);
            actionsDiv.appendChild(youglishBtn);
            
            content.appendChild(wrapper);
            content.appendChild(actionsDiv);
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('vocabModal').classList.add('active');
            
            setTimeout(() => speak(word), 100);
            
            render();
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('vocabModal').classList.remove('active');
        }

        function abbreviateType(type) {
            const abbrev = {
                'noun': 'n',
                'verb': 'v',
                'adjective': 'adj',
                'adverb': 'adv',
                'phrase': 'phr',
                'phrasal verb': 'phr v',
                'noun phrase': 'n phr'
            };
            return abbrev[type] || type;
        }

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();

            // Detect which accent voices are actually available
            hasUKVoice = voices.some(v => v.lang === 'en-GB');
            hasUSVoice = voices.some(v => v.lang === 'en-US');

            // If no UK voice available, default region to US (or whatever is available)
            if (!hasUKVoice && hasUSVoice) {
                currentVoiceRegion = 'US';
            }

            log('Voices loaded. UK:', hasUKVoice, 'US:', hasUSVoice);
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            // Find the best matching voice for the selected region
            let targetVoice = null;

            if (currentVoiceRegion === 'UK' && hasUKVoice) {
                targetVoice = voices.find(v => v.lang === 'en-GB');
            } else if (currentVoiceRegion === 'US' && hasUSVoice) {
                targetVoice = voices.find(v => v.lang === 'en-US');
            } else {
                // Fallback: use any English voice available
                targetVoice = voices.find(v => v.lang.startsWith('en'));
            }
            
            if (targetVoice) {
                utterance.voice = targetVoice;
                utterance.lang = targetVoice.lang;
            }
            
            window.speechSynthesis.speak(utterance);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'dark' ? '' : 'dark';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function hasLessonProgress(category, lesson) {
            const savedState = { 
                currentView: state.currentView,
                currentLesson: state.currentLesson,
                currentType: state.currentType,
                currentPassage: state.currentPassage
            };
            
            state.currentView = category;
            state.currentLesson = lesson;
            
            let allWords = [];
            ['inclass', 'homework'].forEach(type => {
                state.currentType = type;
                const vocabData = getCurrentVocabData();
                allWords = [...allWords, ...Object.keys(vocabData)];
            });
            
            Object.assign(state, savedState);
            
            return allWords.some(w => state.viewedWords.has(w));
        }

        function getTotalWords() {
            let total = 0;
            ['reading', 'listening'].forEach(cat => {
                Object.keys(VOCAB_DATA[cat] || {}).forEach(lesson => {
                    ['inclass', 'homework'].forEach(type => {
                        const data = VOCAB_DATA[cat][lesson][type];
                        total += getAllWordsFromData(data).length;
                    });
                });
            });
            return total;
        }

        function getAllWordsFromData(data) {
            let words = [];
            if (Object.keys(data).length === 0) return words;
            
            const firstKey = Object.keys(data)[0];
            const firstValue = data[firstKey];
            
            if (firstValue && firstValue.ipa) {
                words = Object.keys(data);
            } else {
                Object.keys(data).forEach(passageName => {
                    const passageWords = Object.keys(data[passageName]);
                    words = [...words, ...passageWords];
                });
            }
            
            return words;
        }

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function exportProgress() {
            const data = {
                version: VERSION,
                userId: state.userId,
                viewedWords: Array.from(state.viewedWords),
                reviewSchedule: state.reviewSchedule,
                streak: state.streak,
                quizProgress: state.quizProgress,
                analytics: state.analytics,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ielts-vocab-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            trackEvent('export_progress');
            showToast('‚úÖ ƒê√£ xu·∫•t ti·∫øn ƒë·ªô!');
        }

        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        state.viewedWords = new Set(data.viewedWords || []);
                        state.reviewSchedule = data.reviewSchedule || {};
                        state.streak = data.streak || 0;
                        state.quizProgress = data.quizProgress || {};
                        state.analytics = data.analytics || state.analytics;
                        saveState();
                        render();
                        showToast('‚úÖ ƒê√£ nh·∫≠p ti·∫øn ƒë·ªô th√†nh c√¥ng!');
                        trackEvent('import_progress');
                    } catch (err) {
                        showToast('‚ùå L·ªói: File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        let selectedFeedbackReaction = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            buildWordIndex();
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            }
            
            if ('speechSynthesis' in window) {
                loadVoices();
                setTimeout(loadVoices, 100);
                setTimeout(loadVoices, 500);
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalOverlay').addEventListener('click', closeModal);
            
            const feedbackBtn = document.getElementById('feedbackBtn');
            const feedbackModal = document.getElementById('feedbackModal');
            
            feedbackBtn.addEventListener('click', () => {
                feedbackModal.classList.toggle('active');
                trackEvent('feedback_open');
            });
            
            document.querySelectorAll('.feedback-reaction').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.feedback-reaction').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedFeedbackReaction = btn.dataset.reaction;
                });
            });
            
            document.getElementById('feedbackSubmit').addEventListener('click', () => {
                const text = document.getElementById('feedbackText').value;
                
                if (!selectedFeedbackReaction && !text) {
                    showToast('Vui l√≤ng ch·ªçn ho·∫∑c vi·∫øt feedback!');
                    return;
                }
                
                trackEvent('feedback_submit', { 
                    reaction: selectedFeedbackReaction, 
                    hasText: !!text 
                });
                
                if (CONFIG.GOOGLE_FORM_URL) {
                    const params = new URLSearchParams({
                        userId: state.userId,
                        reaction: selectedFeedbackReaction || 'none',
                        text: text || '',
                        timestamp: new Date().toISOString()
                    });
                    fetch(`${CONFIG.GOOGLE_FORM_URL}?${params}`, { mode: 'no-cors' });
                }
                
                showToast('‚úÖ C·∫£m ∆°n g√≥p √Ω c·ªßa b·∫°n!');
                feedbackModal.classList.remove('active');
                selectedFeedbackReaction = null;
                document.getElementById('feedbackText').value = '';
                document.querySelectorAll('.feedback-reaction').forEach(b => b.classList.remove('selected'));
            });
            
            document.addEventListener('click', (e) => {
                if (!feedbackModal.contains(e.target) && !feedbackBtn.contains(e.target)) {
                    feedbackModal.classList.remove('active');
                }
            });
            
            window.addEventListener('beforeunload', () => {
                trackEvent('session_end', { 
                    duration: Date.now() - state.analytics.sessionStart 
                });
                sendAnalytics();
            });
            
            render();
            
            console.log(`%cüìö IELTS Vocab Stream v${VERSION}`, 'font-size: 20px; font-weight: bold; color: #2d5016;');
            console.log('%cNeed help? Check MAINTENANCE.md', 'color: #666;');
        });
    </script>
</body>
</html>
