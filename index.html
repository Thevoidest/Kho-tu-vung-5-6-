<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Vocab Stream</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&family=JetBrains+Mono:wght@500&display=swap');

        :root {
            --bg: #fdfcfa;
            --text: #1a1614;
            --primary: #2d5016;
            --primary-light: #4a7c2e;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --surface: #ffffff;
            --surface-elevated: #f8f7f5;
            --border: #e8e6e3;
            --success: #10b981;
            --shadow: rgba(26, 22, 20, 0.08);
        }

        [data-theme="dark"] {
            --bg: #0f0e0d;
            --text: #e8e6e3;
            --primary: #6b9b4d;
            --primary-light: #8bb56a;
            --accent: #fbbf24;
            --accent-light: #fcd34d;
            --surface: #1a1614;
            --surface-elevated: #252220;
            --border: #3a3632;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -1px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-switch {
            width: 56px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .theme-switch::before {
            content: '‚òÄÔ∏è';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            transition: all 0.3s;
        }

        [data-theme="dark"] .theme-switch::before {
            content: 'üåô';
            left: 30px;
        }

        /* ===== NAVIGATION ===== */
        .main-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            background: var(--surface);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .nav-item {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item:not(.active):hover {
            background: var(--surface-elevated);
        }

        /* ===== LESSON SELECTOR ===== */
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .lesson-btn {
            padding: 18px 12px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text);
            position: relative;
        }

        .lesson-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .lesson-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .lesson-btn.has-progress::after {
            content: '‚úì';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== TYPE SELECTOR ===== */
        .type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        .type-btn {
            flex: 1;
            padding: 12px 32px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
        }

        .type-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .type-btn:hover:not(.active) {
            border-color: var(--accent-light);
        }

        /* ===== PASSAGE SELECTOR ===== */
        .passage-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .passage-btn {
            padding: 10px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text);
            white-space: nowrap;
        }

        .passage-btn.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .passage-btn:hover:not(.active) {
            border-color: var(--primary-light);
            background: var(--surface-elevated);
        }

        /* ===== PARAGRAPH BADGE ===== */
        .paragraph-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
        }

        .paragraph-badge.para-A { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .paragraph-badge.para-B { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .paragraph-badge.para-C { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .paragraph-badge.para-D { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .paragraph-badge.para-E { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .paragraph-badge.para-F { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .paragraph-badge.para-G { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .paragraph-badge.para-H { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .paragraph-badge.para-I { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }

        /* ===== VOCAB CARD - ‚úÖ FIXED: To√†n b·ªô card clickable ===== */
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
        }

        .vocab-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            user-select: none; /* ‚úÖ Prevent text selection */
        }

       /* h·ªìi tr∆∞·ªõc ·ªü ƒë√¢y l√† code hover*/

        .vocab-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px var(--shadow);
            border-color: var(--primary-light);
        }

        .vocab-card.viewed {}

        .vocab-card.viewed::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            pointer-events: none;
        }

        /* ‚úÖ FIXED: Layout ngang - T·ª´ b√™n tr√°i, lo·∫°i t·ª´ b√™n ph·∫£i */
        .vocab-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            pointer-events: none; /* ‚úÖ Prevent blocking clicks */
        }

        .vocab-word {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 1;
            min-width: 0;
            pointer-events: none;
        }

        /* ‚úÖ FIXED: Vi·∫øt t·∫Øt t·ª´ lo·∫°i (n, v, adj...) */
        .vocab-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: lowercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-shrink: 0;
             pointer-events: none;
        }

        .vocab-type {
            background: #f3f4f6;
            color: #374151;
        }

        .type-verb {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-noun {
            background: #d1fae5;
            color: #065f46;
        }

        .type-adjective {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .type-adverb {
            background: #fed7aa;
            color: #9a3412;
        }

        .type-phrase {
            background: #fce7f3;
            color: #9f1239;
        }

        [data-theme="dark"] .vocab-type {
            background: #374151;
            color: #d1d5db;
        }

        [data-theme="dark"] .type-verb {
            background: #1e3a8a;
            color: #93c5fd;
        }

        [data-theme="dark"] .type-noun {
            background: #064e3b;
            color: #6ee7b7;
        }

        [data-theme="dark"] .type-adjective {
            background: #581c87;
            color: #d8b4fe;
        }

        [data-theme="dark"] .type-adverb {
            background: #7c2d12;
            color: #fdba74;
        }

        [data-theme="dark"] .type-phrase {
            background: #831843;
            color: #fbcfe8;
        }

        .vocab-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--primary-light);
            display: none;
        }

        /* ===== MODAL - ‚úÖ COMPACT & OPTIMIZED ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            display: none;
            z-index: 998;
            pointer-events: none; 
        }

        .modal-overlay.active {
            display: block;
            pointer-events: auto;
        }

        .vocab-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--surface);
            border-radius: 16px;
            padding: 24px; /* ‚úÖ Gi·∫£m padding */
            max-width: 440px; /* ‚úÖ Thu nh·ªè modal */
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .vocab-modal.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--surface-elevated);
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border);
            transform: rotate(90deg);
        }

        /* ‚úÖ FIXED: Layout ngang trong modal */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .modal-word {
            font-size: 28px; /* ‚úÖ Gi·∫£m size */
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 1;
            min-width: 0;
        }

        .modal-type {
            display: inline-block;
            padding: 4px 10px;
            background: var(--accent-light);
            color: #78350f;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .modal-ipa {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--primary-light);
            margin-bottom: 12px;
        }

        /* ‚úÖ FIXED: Font ti·∫øng Vi·ªát l·ªõn h∆°n, d·ªÖ ƒë·ªçc */
        .modal-meaning {
            font-size: 17px; /* ‚úÖ TƒÉng t·ª´ 16px */
            line-height: 1.65;
            color: var(--text);
            margin-bottom: 12px;
            padding: 14px;
            background: var(--surface-elevated);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }

        .modal-paraphrase {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            padding: 12px;
            background: var(--surface-elevated);
            border-radius: 10px;
            font-style: italic;
            opacity: 0.9;
        }

        /* ‚úÖ FIXED: Buttons nh·ªè g·ªçn h∆°n */
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 8px; /* ‚úÖ Gi·∫£m gap */
            margin-top: 16px; /* ‚úÖ Gi·∫£m margin */
        }

        .btn {
            padding: 10px 16px; /* ‚úÖ Gi·∫£m padding */
            border: none;
            border-radius: 10px;
            font-size: 13px; /* ‚úÖ Gi·∫£m font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-secondary {
            background: var(--surface-elevated);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--primary-light);
        }

        /* ===== STATS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text);
            opacity: 0.7;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== ANALYTICS SECTION ===== */
        .analytics-section {
            margin-top: 30px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
        }

        .analytics-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .analytics-item {
            background: var(--surface-elevated);
            padding: 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analytics-label {
            font-size: 14px;
            color: var(--text);
            opacity: 0.8;
        }

        .analytics-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text);
            padding: 16px 28px;
            border-radius: 50px;
            box-shadow: 0 8px 24px var(--shadow);
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            border: 1px solid var(--border);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            header {
                margin-bottom: 24px;
            }

            .logo {
                font-size: 28px;
            }

            .vocab-grid {
                grid-template-columns: 1fr;
            }

            .lesson-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            }

            .vocab-modal {
                padding: 20px;
                width: 95%;
            }

            .modal-word {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="logo">IELTS Vocab Stream</div>
        <div class="header-controls">
            <div class="theme-switch" id="themeToggle"></div>
        </div>
    </header>

    <nav class="main-nav">
        <button class="nav-item active" data-view="reading">üìñ Reading</button>
        <button class="nav-item" data-view="listening">üéß Listening</button>
        <button class="nav-item" data-view="stats">üìä Stats</button>
    </nav>

    <div id="contentArea"></div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="vocab-modal" id="vocabModal">
    <button class="modal-close" id="modalClose">‚úï</button>
    <div id="modalContent"></div>
</div>

<script src="vocab-data.js"></script>

<script>
// ==========================================
// STATE MANAGEMENT
// ==========================================

const state = {
    currentView: 'reading',
    currentLesson: 1,
    currentType: 'inclass',
    currentPassage: null,
    viewedWords: new Set(),
    analytics: {
        voiceClicks: { UK: 0, US: 0 },
        youglishClicks: 0,
        totalModalOpens: 0
    }
};

const URLHashManager = {
    save(view, lesson, type) {
        window.location.hash = `${view}/${lesson}/${type}`;
    },
    load() {
        const hash = window.location.hash.slice(1);
        if (!hash) return null;
        const [view, lesson, type] = hash.split('/');
        if (view && lesson && type) {
            const lessonNum = parseInt(lesson);
            return { view, lesson: lessonNum, type };
        }
        return null;
    }
};

function saveState() {
    localStorage.setItem('ielts_vocab_state', JSON.stringify({
        viewedWords: Array.from(state.viewedWords),
        analytics: state.analytics
    }));
}

function loadState() {
    const saved = localStorage.getItem('ielts_vocab_state');
    if (saved) {
        const data = JSON.parse(saved);
        state.viewedWords = new Set(data.viewedWords || []);
        state.analytics = data.analytics || { voiceClicks: { UK: 0, US: 0 }, youglishClicks: 0, totalModalOpens: 0 };
    }
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    if (newTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
    } else {
        document.body.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
    }
}

// ‚úÖ TRACKING ANALYTICS
function trackEvent(eventType, data = {}) {
    if (eventType === 'voice_click') {
        state.analytics.voiceClicks[data.region]++;
    } else if (eventType === 'youglish_click') {
        state.analytics.youglishClicks++;
    } else if (eventType === 'modal_open') {
        state.analytics.totalModalOpens++;
    }
    saveState();
}

// ==========================================
// SPEECH SYNTHESIS
// ==========================================

let availableVoices = [];
let currentVoiceRegion = 'US';

function loadVoices() {
    availableVoices = window.speechSynthesis.getVoices();
    if (availableVoices.length === 0) {
        const dummy = new SpeechSynthesisUtterance('');
        window.speechSynthesis.speak(dummy);
        window.speechSynthesis.cancel();
        availableVoices = window.speechSynthesis.getVoices();
    }
}
}

function speak(word) {
    // ‚úÖ iOS fix: Ensure voices loaded
    if (availableVoices.length === 0) loadVoices();
    
    window.speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.85;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // ‚úÖ Simple logic: T√¨m theo region
    let selectedVoice = availableVoices.find(v => 
        currentVoiceRegion === 'UK' 
            ? v.lang.startsWith('en-GB') 
            : v.lang.startsWith('en-US')
    );
    
    // Fallback v·ªÅ b·∫•t k·ª≥ gi·ªçng English n√†o
    if (!selectedVoice) {
        selectedVoice = availableVoices.find(v => v.lang.startsWith('en-'));
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
        
        // ‚úÖ ƒêi·ªÅu ch·ªânh rate cho UK (ho·∫∑c US fallback cho UK request)
        if (selectedVoice.lang.startsWith('en-GB') || 
            (currentVoiceRegion === 'UK' && selectedVoice.lang.startsWith('en-US'))) {
            utterance.rate = 0.75;
            if (selectedVoice.lang.startsWith('en-US')) {
                utterance.pitch = 0.95; // Th·∫•p h∆°n m·ªôt ch√∫t khi d√πng US cho UK
            }
        }
    }
    
    window.speechSynthesis.speak(utterance);
}

// ==========================================
// ‚úÖ ABBREVIATE WORD TYPES
// ==========================================

function abbreviateType(type) {
    const abbrevMap = {
        'noun': 'n',
        'verb': 'v',
        'adjective': 'adj',
        'adverb': 'adv',
        'phrase': 'phr',
        'conjunction': 'conj',
        'preposition': 'prep',
        'pronoun': 'pron',
        'interjection': 'interj'
    };
    
    const lowerType = type.toLowerCase();
    for (const [full, abbr] of Object.entries(abbrevMap)) {
        if (lowerType.includes(full)) {
            return abbr;
        }
    }
    return type.toLowerCase();
}

// ==========================================
// NAVIGATION
// ==========================================

function setView(view) {
    state.currentView = view;
    
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
    });
    
    render();
}

function setLesson(num) {
    state.currentLesson = num;
    state.currentType = 'inclass';
    state.currentPassage = null;
    URLHashManager.save(state.currentView, state.currentLesson, state.currentType);
    render();
}

function setType(type) {
    state.currentType = type;
    state.currentPassage = null;
    URLHashManager.save(state.currentView, state.currentLesson, state.currentType);
    render();
}

function setPassage(passage) {
    state.currentPassage = passage;
    render();
}

// ==========================================
// RENDERING
// ==========================================

function render() {
    const contentArea = document.getElementById('contentArea');
    
    if (state.currentView === 'stats') {
        renderStats(contentArea);
        return;
    }
    
    const category = VOCAB_DATA[state.currentView];
    if (!category) return;
    
    const lessons = Object.keys(category).map(Number).sort((a, b) => a - b);
    
    let html = '';
    
    html += '<div class="lesson-grid">';
    lessons.forEach(lessonNum => {
        const isActive = lessonNum === state.currentLesson;
        const hasProgress = hasLessonProgress(state.currentView, lessonNum);
        html += `
            <button 
                class="lesson-btn ${isActive ? 'active' : ''} ${hasProgress ? 'has-progress' : ''}"
                onclick="setLesson(${lessonNum})"
            >
                L${lessonNum}
            </button>
        `;
    });
    html += '</div>';
    
    html += `
        <div class="type-selector">
            <button 
                class="type-btn ${state.currentType === 'inclass' ? 'active' : ''}"
                onclick="setType('inclass')"
            >
                üìö In-Class
            </button>
            <button 
                class="type-btn ${state.currentType === 'homework' ? 'active' : ''}"
                onclick="setType('homework')"
            >
                üìù Homework
            </button>
        </div>
    `;
    
    const vocabData = getCurrentVocabData();
    if (state.currentView === 'reading' && vocabData && Object.keys(vocabData).length > 0) {
        const firstKey = Object.keys(vocabData)[0];
        const firstValue = vocabData[firstKey];
        
        if (firstValue && firstValue.ipa) {
            // Flat structure
        } else {
            const passages = Object.keys(vocabData);
            if (passages.length > 1) {
                html += '<div class="passage-selector">';
                html += `
                    <button 
                        class="passage-btn ${state.currentPassage === null ? 'active' : ''}"
                        onclick="setPassage(null)"
                    >
                        üìö All Passages
                    </button>
                `;
                passages.forEach(passageName => {
                    const isActive = passageName === state.currentPassage;
                    html += `
                        <button 
                            class="passage-btn ${isActive ? 'active' : ''}"
                            onclick="setPassage('${passageName}')"
                        >
                            ${passageName}
                        </button>
                    `;
                });
                html += '</div>';
            }
        }
    }
    
    html += '<div class="vocab-grid">';
    const words = getWordsToDisplay();
    words.forEach(([word, data]) => {
        const isViewed = state.viewedWords.has(word);
        const paragraphBadge = (state.currentView === 'reading' && data.paragraph)
            ? `<div class="paragraph-badge para-${data.paragraph}">${data.paragraph}</div>` 
            : '';
        
        const abbrevType = abbreviateType(data.type);
        const typeClass = 'type-' + data.type.toLowerCase().split('/')[0].split(' ')[0];
        
        html += `
            <div class="vocab-card ${isViewed ? 'viewed' : ''}" onclick="event.stopPropagation(); openModal('${word}')">
                ${paragraphBadge}
                <div class="vocab-header">
                    <div class="vocab-word">${word}</div>
                    <div class="vocab-type ${typeClass}">${abbrevType}</div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    contentArea.innerHTML = html;
}

function renderStats(container) {
    const totalWords = getTotalWords();
    const viewedCount = state.viewedWords.size;
    const percentage = totalWords > 0 ? Math.round((viewedCount / totalWords) * 100) : 0;
    
    const readingTotal = getCategoryTotal('reading');
    const readingViewed = getCategoryViewed('reading');
    const readingPercent = readingTotal > 0 ? Math.round((readingViewed / readingTotal) * 100) : 0;
    
    const listeningTotal = getCategoryTotal('listening');
    const listeningViewed = getCategoryViewed('listening');
    const listeningPercent = listeningTotal > 0 ? Math.round((listeningViewed / listeningTotal) * 100) : 0;
    
    const ukClicks = state.analytics.voiceClicks.UK || 0;
    const usClicks = state.analytics.voiceClicks.US || 0;
    const youglishClicks = state.analytics.youglishClicks || 0;
    const totalModalOpens = state.analytics.totalModalOpens || 0;
    
    container.innerHTML = `
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">${viewedCount}</div>
                <div class="stat-label">Words Learned</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">${totalWords}</div>
                <div class="stat-label">Total Words</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">${percentage}%</div>
                <div class="stat-label">Progress</div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">${readingViewed}/${readingTotal}</div>
                <div class="stat-label">üìñ Reading</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${readingPercent}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">${listeningViewed}/${listeningTotal}</div>
                <div class="stat-label">üéß Listening</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${listeningPercent}%"></div>
                </div>
            </div>
        </div>
        
        <div class="analytics-section">
            <div class="analytics-title">üìä Usage Analytics</div>
            <div class="analytics-grid">
                <div class="analytics-item">
                    <span class="analytics-label">üá¨üáß UK Voice</span>
                    <span class="analytics-value">${ukClicks}</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-label">üá∫üá∏ US Voice</span>
                    <span class="analytics-value">${usClicks}</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-label">üé¨ B·ªëi c·∫£nh</span>
                    <span class="analytics-value">${youglishClicks}</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-label">üëÅÔ∏è Popups</span>
                    <span class="analytics-value">${totalModalOpens}</span>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-primary" onclick="exportProgress()" style="flex: 1;">
                üì• Export Progress
            </button>
            <button class="btn btn-secondary" onclick="importProgress()" style="flex: 1;">
                üì§ Import Progress
            </button>
        </div>
    `;
}

function getCurrentVocabData() {
    const category = VOCAB_DATA[state.currentView];
    if (!category) return {};
    
    const lesson = category[state.currentLesson];
    if (!lesson) return {};
    
    return lesson[state.currentType] || {};
}

function getWordsToDisplay() {
    const vocabData = getCurrentVocabData();
    
    if (!vocabData || Object.keys(vocabData).length === 0) {
        return [];
    }
    
    const firstKey = Object.keys(vocabData)[0];
    const firstValue = vocabData[firstKey];
    
    if (firstValue && firstValue.ipa) {
        return Object.entries(vocabData);
    }
    
    if (state.currentPassage && vocabData[state.currentPassage]) {
        return Object.entries(vocabData[state.currentPassage]);
    }
    
    let allWords = [];
    Object.keys(vocabData).forEach(passageName => {
        const passageWords = Object.entries(vocabData[passageName]);
        allWords = [...allWords, ...passageWords];
    });
    
    return allWords;
}

// ==========================================
// MODAL
// ==========================================

function openModal(word) {
    trackEvent('modal_open');
    
    const vocabData = getCurrentVocabData();
    let data = null;
    
    const firstKey = Object.keys(vocabData)[0];
    const firstValue = vocabData[firstKey];
    
    if (firstValue && firstValue.ipa) {
        data = vocabData[word];
    } else {
        Object.keys(vocabData).forEach(passageName => {
            if (vocabData[passageName][word]) {
                data = vocabData[passageName][word];
            }
        });
    }
    
    if (!data) return;
    
    state.viewedWords.add(word);
    saveState();
    
    const youglishUrl = `https://youglish.com/pronounce/${encodeURIComponent(word)}/english`;
    
    const content = document.getElementById('modalContent');
    content.innerHTML = '';
    
    const wrapper = document.createElement('div');
    
    const headerDiv = document.createElement('div');
    headerDiv.className = 'modal-header';
    
    const wordElem = document.createElement('div');
    wordElem.className = 'modal-word';
    wordElem.textContent = word;
    
    const abbrevType = abbreviateType(data.type);
    const typeElem = document.createElement('div');
    typeElem.className = 'modal-type';
    typeElem.textContent = abbrevType;
    
    headerDiv.appendChild(wordElem);
    headerDiv.appendChild(typeElem);
    
    const ipaElem = document.createElement('div');
    ipaElem.className = 'modal-ipa';
    ipaElem.textContent = data.ipa;
    
    const meaningElem = document.createElement('div');
    meaningElem.className = 'modal-meaning';
    meaningElem.innerHTML = data.meaning;
    
    const paraphraseElem = document.createElement('div');
    paraphraseElem.className = 'modal-paraphrase';
    paraphraseElem.innerHTML = data.paraphrase;
    
    wrapper.appendChild(headerDiv);
    wrapper.appendChild(ipaElem);
    wrapper.appendChild(meaningElem);
    wrapper.appendChild(paraphraseElem);
    
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'modal-actions';
    
    const voiceSelector = document.createElement('div');
    voiceSelector.style.cssText = 'display: flex; gap: 8px;';
    
    const ukBtn = document.createElement('button');
    ukBtn.className = 'btn ' + (currentVoiceRegion === 'UK' ? 'btn-primary' : 'btn-secondary');
    ukBtn.innerHTML = 'üá¨üáß UK';
    ukBtn.style.flex = '1';
    ukBtn.addEventListener('click', () => {
        currentVoiceRegion = 'UK';
        speak(word);
        trackEvent('voice_click', { region: 'UK' });
        ukBtn.className = 'btn btn-primary';
        usBtn.className = 'btn btn-secondary';
    });
    
    const usBtn = document.createElement('button');
    usBtn.className = 'btn ' + (currentVoiceRegion === 'US' ? 'btn-primary' : 'btn-secondary');
    usBtn.innerHTML = 'üá∫üá∏ US';
    usBtn.style.flex = '1';
    usBtn.addEventListener('click', () => {
        currentVoiceRegion = 'US';
        speak(word);
        trackEvent('voice_click', { region: 'US' });
        usBtn.className = 'btn btn-primary';
        ukBtn.className = 'btn btn-secondary';
    });
    
    voiceSelector.appendChild(ukBtn);
    voiceSelector.appendChild(usBtn);
    
    const youglishBtn = document.createElement('button');
    youglishBtn.className = 'btn btn-secondary';
    youglishBtn.innerHTML = 'üé¨ B·ªëi c·∫£nh th·ª±c t·∫ø';
    youglishBtn.addEventListener('click', () => {
        trackEvent('youglish_click');
        window.open(youglishUrl, '_blank');
    });
    
    actionsDiv.appendChild(voiceSelector);
    actionsDiv.appendChild(youglishBtn);
    
    content.appendChild(wrapper);
    content.appendChild(actionsDiv);
    
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('vocabModal').classList.add('active');
    
    setTimeout(() => speak(word), 100);
    
    render();
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('vocabModal').classList.remove('active');
}

// ==========================================
// UTILITIES
// ==========================================

function hasLessonProgress(category, lesson) {
    const savedState = { 
        currentView: state.currentView,
        currentLesson: state.currentLesson,
        currentType: state.currentType,
        currentPassage: state.currentPassage
    };
    
    state.currentView = category;
    state.currentLesson = lesson;
    
    let allWords = [];
    ['inclass', 'homework'].forEach(type => {
        state.currentType = type;
        const vocabData = getCurrentVocabData();
        allWords = [...allWords, ...Object.keys(vocabData)];
    });
    
    Object.assign(state, savedState);
    
    return allWords.some(w => state.viewedWords.has(w));
}

function getAllWordsFromData(data) {
    let words = [];
    
    if (Object.keys(data).length === 0) return words;
    
    const firstKey = Object.keys(data)[0];
    const firstValue = data[firstKey];
    
    if (firstValue && firstValue.ipa) {
        words = Object.keys(data);
    } else {
        Object.keys(data).forEach(passageName => {
            const passageWords = Object.keys(data[passageName]);
            words = [...words, ...passageWords];
        });
    }
    
    return words;
}

function getTotalWords() {
    let total = 0;
    ['reading', 'listening'].forEach(cat => {
        Object.keys(VOCAB_DATA[cat]).forEach(lesson => {
            ['inclass', 'homework'].forEach(type => {
                const data = VOCAB_DATA[cat][lesson][type];
                const words = getAllWordsFromData(data);
                total += words.length;
            });
        });
    });
    return total;
}

function getCategoryTotal(category) {
    let total = 0;
    Object.keys(VOCAB_DATA[category]).forEach(lesson => {
        ['inclass', 'homework'].forEach(type => {
            const data = VOCAB_DATA[category][lesson][type];
            const words = getAllWordsFromData(data);
            total += words.length;
        });
    });
    return total;
}

function getCategoryViewed(category) {
    let viewed = 0;
    Object.keys(VOCAB_DATA[category]).forEach(lesson => {
        ['inclass', 'homework'].forEach(type => {
            const data = VOCAB_DATA[category][lesson][type];
            const words = getAllWordsFromData(data);
            words.forEach(w => {
                if (state.viewedWords.has(w)) viewed++;
            });
        });
    });
    return viewed;
}

function exportProgress() {
    const data = {
        viewedWords: Array.from(state.viewedWords),
        analytics: state.analytics,
        exportDate: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ielts-vocab-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importProgress() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                state.viewedWords = new Set(data.viewedWords || []);
                state.analytics = data.analytics || { voiceClicks: { UK: 0, US: 0 }, youglishClicks: 0, totalModalOpens: 0 };
                saveState();
                render();
                showToast('‚úÖ Progress imported successfully!');
            } catch (err) {
                showToast('‚ùå Error importing file. Please check the file format.');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function showToast(message) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

// ==========================================
// INITIALIZATION
// ==========================================

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    
    const hashState = URLHashManager.load();
    if (hashState) {
        state.currentView = hashState.view;
        state.currentLesson = hashState.lesson;
        state.currentType = hashState.type;
    }
    
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    }
    
    if ('speechSynthesis' in window) {
        loadVoices();
        setTimeout(loadVoices, 100);
        setTimeout(loadVoices, 500);
        setTimeout(loadVoices, 1000);
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
    
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => setView(btn.dataset.view));
    });
    
    render();
});
</script>

</body>
</html>
